---
title: "Subsequent Infections - Aim 2 & 3 Study Analysis "
date: "`r format(Sys.time(), '%m-%d-%y')`"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_collapsed: yes
    toc_float: yes
---

Report for progress on study modeling and analysis for the comparison of the presence of post-acute Respiratory infection in COVID-positive patients compared to comparison groups (influenza infections).

```{r include=FALSE}
# Default taken from R notebook behavior: when knitting, wd will always be location of notebook
base_dir <- '..'
Sys.setenv(PEDSNET_SKIP_REQUEST_EXECUTION=1)
try(source('../site/run.R')) # May not be able to make db connection
try(source('site/run.R'))

# Set to "local" to read data from ../results, or another value to read from db
data_source <- if_else(config('execution_mode') == 'distribution', 'local', 'not_local')

require(tibble)
require(knitr)
require(kableExtra)
require(readr)
require(table1)
require(ggplot2)
library(GGally)
require(tidyverse)
require(lubridate)
library(wesanderson)
library(survey)
library(survival)
library(WeightIt)
library(cobalt)
library(jtools)
require(cobalt)
require(WeightIt)
require(scattermore)
require(broom)
require(tableone)

get_results <- function(tbl_name) {
  if (data_source == 'local') {
    rslt <- read_csv(paste0('../results/', tbl_name, '.csv'))
  }
  else {
    rslt <- results_tbl(tbl_name) %>% collect()
  }
  rslt
}


prettify_kable <- function(data, indents = list()) {
  
  if (length(indents)==0) {
      data %>% 
        kbl(digits = 2, format.args = list(big.mark = ',')) %>%
        kable_classic(full_width = F, html_font = "Arial") %>% 
        kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>% 
        column_spec(1, bold = F, border_right = T)
  } else {
      data %>% 
        kbl(digits = 2, format.args = list(big.mark = ',')) %>%
        kable_classic(full_width = F, html_font = "Arial") %>% 
        kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>% 
        add_indent(indents) %>% 
        column_spec(1, bold = F, border_right = T)
  }

  # 
  # data %>% 
  #   kable(digits = 2, format.args = list(big.mark = ',')) %>% 
  #   kable_styling(bootstrap_options = c("striped", "hover")) %>% 
  #   column_spec(1, bold = T, border_right = T)
}

my.render.cont <- function(x) {
  with(stats.apply.rounding(stats.default(x), digits = 6), c("",
    "Mean (SD)" = sprintf("%0.1f (%0.1f)", as.numeric(MEAN), as.numeric(SD)),
    "Median [Q1-Q3]" = sprintf("%0.1f [%0.1f - %0.1f]", as.numeric(MEDIAN), as.numeric(Q1), as.numeric(Q3))
  ))
}

my.render.cat <- function(x) {
  c("", sapply(stats.default(x), function(y) {
    with(
      y,
      sprintf("%s (%0.1f%%)", format(FREQ, big.mark = ","), PCT)
    )
  }))
}

pvalue <- function(x, ...) {
  # Construct vectors of data y, and groups (strata) g
  # from https://cran.r-project.org/web/packages/table1/vignettes/table1-examples.html#example-a-column-of-p-values

  y <- unlist(x)
  g <- factor(rep(1:length(x), times = sapply(x, length)))
  if (is.numeric(y)) {
    # For numeric variables, perform a standard 2-sample t-test
    p <- t.test(y ~ g)$p.value
  } else {
    # For categorical variables, perform a chi-squared test of independence
    p <- chisq.test(table(y, g))$p.value
  }
  # Format the p-value, using an HTML entity for the less-than sign.
  # The initial empty string places the output on the line below the variable label.
  c("", sub("<", "&lt;", format.pval(p, digits = 3, eps = 0.001)))
}

# fron https://rdrr.io/github/junkka/ehahelper/src/R/broom_coxme.R
tidy.coxme <- function(x, exponentiate = FALSE, conf.int = 0.95, ...) {
  beta <- x$coefficients
  nvar <- length(beta)
  nfrail <- nrow(x$var) - nvar
  nn <- c("estimate", "exp()", "std.error", "statistic", "p.value")
  se <- sqrt(diag(as.matrix(x$var))[nfrail + 1:nvar])
  z <- qnorm((1 + conf.int) / 2, 0, 1)
  ret <- data.frame(
    "term" = names(beta),
    "estimate" = beta,
    "std.error" = se,
    "statistic" = beta / se,
    "p.value" = 1 - pchisq((beta / se)^2, 1),
    "conf.low" = beta - z * se,
    "conf.high" = beta + z * se,
    "beta" = beta
  )
  if (exponentiate) {
    ret$estimate <- exp(ret$estimate)
    ret$conf.low <- exp(ret$conf.low)
    ret$conf.high <- exp(ret$conf.high)
  }
  rownames(ret) <- c(1:nrow(ret))
  ret
}

  postacute_min_start_date = as.Date("2021-07-01")
  postacute_max_end_date = as.Date("2023-03-01")
  
  cohort_entry_start_date = as.Date("2021-06-01")
  cohort_entry_end_date = as.Date("2023-02-01")
  
  cohort_1_label = "resp_study_cohort"


description = "covid_flu_3"
description = "covid_flu_noutil"
description = "covid_flu_util"
# description = "covid_ari_util"
# description = "covid_ari_ce_week"
description = "covid_flu_nonexclude"

description = "covid_flu_comparison"
# description = "covid_ari_comparison"
# comparison_group_string = "Respiratory"
comparison_group_string = "Influenza"


analytic_dataset <-
  results_tbl(paste0(cohort_1_label, "_analytic_dataset")) %>% 
  filter(ce_date >= cohort_entry_start_date,
         ce_date < cohort_entry_end_date)

analytic_dataset_final <-
  analytic_dataset %>% 
  filter(sex_cat != "Other/unknown") %>% 
  filter(is.na(covid_index_date_imputed) | covid_index_date_imputed==0) %>% 
  group_by(person_id) %>% # TODO might need to filter earliest resp date or something
  ungroup() %>% 
  mutate(lab_confirmed_index = ifelse(lab_confirmed==1, "lab confirmed", "dx only")) %>% 
  # mutate(visit_span_criteria_rank = as.character(visit_span_criteria_rank)) %>% 
  mutate(hospitalized_at_index = ifelse(hospital_flag==1 & visit_span_criteria_rank=="1", "Hospitalized", "Not hospitalized")) %>% 
  mutate(hospital_flag = as.character(hospital_flag)) %>% 
  mutate(hosp_with_vent = as.character(hosp_with_vent)) %>% 
  mutate(hospitalized_at_index = ifelse(is.na(hospitalized_at_index), "Not hospitalized", hospitalized_at_index)) %>% 
  mutate(hosp_with_vent = ifelse(is.na(hosp_with_vent), "0", hosp_with_vent))  %>% 
  mutate(hospitalized_at_index_detail = ifelse(hospitalized_at_index=="Hospitalized" & hosp_with_vent=="1", "Hospitalized with ventilation", hospitalized_at_index)) %>% 
  mutate(resp_outcome_is_reinfection = case_when(resp_outcome_flu_related=="x" & sub_cohort=="Influenza" ~ "1",
                                                 outcome_covid30d=="1" & sub_cohort=="COVID" ~ "1",
                                                 TRUE ~ "0")) %>% 
  # mutate(rsv_outcome_postacute = ifelse(rsv_occurrence_period == "post acute (15-180 days after index)", 1, 0)) %>% 
  collect()

visit_counts <- results_tbl(paste0(cohort_1_label, "_visit_lookback_counts")) %>% 
  collect()

```


# Section 1: Attrition and Variables

## Attrition

(TODO neaten up this table with the right order )

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=8, fig.height=6}
attrition <- results_tbl(paste0(cohort_1_label, "_attrition")) %>% 
  collect()

attrition_ordered <- attrition %>% 
  mutate(ordering = case_when(
    cohort == "Patients under 6 years old with at least 1 visit during CE period" ~ 1,
    cohort == "Had at least 1 of COVID, influenza infection event during CE period" ~ 2,
    cohort == "Had COVID during CE period" ~ 3,
    cohort == "Had influenza during CE period" ~ 4,
    cohort == "Meets utilization inclusion criteria" ~ 5,
    cohort == "Not excluded due to overlapping index infections" ~ 6,
    cohort == "Final COVID sub-cohort" ~ 7,
    cohort == "Final Influenza sub-cohort" ~8,
    TRUE ~ 0
  ))


attrition_ordered %>%
  select("Attrition step" = cohort, persons, ordering) %>%
  filter(ordering > 0) %>%
  arrange(ordering) %>%
  select(-ordering) %>%
  prettify_kable(c(3, 4, 7, 8))

```



## Table 1

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=8, fig.height=6}
  
# table1(~ sex_cat + race_eth_cat + age_cat_at_ce + 
#          visit_type_inpatient +
#          visit_type_outpatient +
#          visit_type_ed + 
#          visit_type_other +
#          visit_span_criteria_rank + hospital_flag +
#          insurance_class
#          | sub_cohort*lab_confirmed_index, 
#        overall = F,
#        data = final_dataset)

table1(~ sex_cat + race_eth_cat + age_cat_at_ce + 
         util_inpatient +
         util_outpatient +
         util_ed + 
         util_other +
         visit_type_inpatient +
         visit_type_outpatient +
         visit_type_ed + 
         visit_type_other +
         lab_confirmed_index +
         hospitalized_at_index +
         hospitalized_at_index_detail +
         # complex_chronic_flag +
         insurance_class
         | sub_cohort, 
       overall = T,
       data = analytic_dataset_final)

analytic_dataset_final %>% 
  select(ce_date, sub_cohort, days_from_index_to_first30d_resp, first30d_resp_date) %>% 
  filter(!is.na(days_from_index_to_first30d_resp)) %>% 
  pivot_longer(cols=c("ce_date", "first30d_resp_date"), names_to = "Event", values_to = "dates") %>% 
  ggplot() +
  # geom_histogram(aes(x=dates, fill = plot_cohort), alpha=0.9) +
  geom_density(aes(x=dates, fill = sub_cohort, color = sub_cohort), alpha=0.75, position="dodge") +
  facet_wrap(~Event, scales = "free_y", ncol=1) +
  # geom_histogram(aes(x=ce_date, fill = sub_cohort, color = "Index infection")) +
  # geom_histogram(aes(x=rsv_evidence_date, fill = sub_cohort, color = "RSV outcome"), alpha=0.5)+
  # scale_color_brewer(palette = "Set1") +
  scale_fill_brewer(palette = "Set1")+
  scale_color_brewer(palette = "Set1") +
  # scale_fill_manual(values = wes_palette("FantasticFox1", n=4, type = "continuous")) +
  # scale_color_manual(values = wes_palette("FantasticFox1", n=4, type = "continuous")) +
  theme_bw() +
  theme(legend.position = "top") 

# ggsave("results/abstract_fig_1.png", width = 6, height = 4, dpi = 500)
  

```


## Utilization Data

Distributions of utilization data

```{r warning = FALSE, message = FALSE, echo = FALSE, fig.width=8, fig.height=6}
plot_util <- function(df, cutoff, visit_type) {
  df %>% 
  filter(n_visits_type< cutoff) %>% 
  filter(visit_type_rough==visit_type) %>%
  ggplot() + 
  geom_histogram(aes(x=n_visits_type, fill = sub_cohort)) +
  facet_wrap(~sub_cohort, scales="free", ncol=3) +
  theme_bw() +
  scale_fill_brewer(palette = "Dark2") +
    labs(x="number visits", y = "n patients") +
  theme(legend.position = "bottom") %>% 
    return()
}

visits_cohort <- visit_counts %>% 
  inner_join(analytic_dataset_final %>%
              select(person_id, sub_cohort), by="person_id")

visits_cohort %>% 
  plot_util(cutoff = 30, visit_type = "outpatient") +
  ggtitle("Outpatient visit distributions")

visits_cohort %>% 
  plot_util(cutoff = 15, visit_type = "inpatient") +
  ggtitle("Inpatient visit distributions")

visits_cohort %>% 
  plot_util(cutoff = 15, visit_type = "ed") +
  ggtitle("ED visit distributions")

visits_cohort %>% 
  plot_util(cutoff = 40, visit_type = "other") +
  ggtitle("Other types visit distributions")





```

# Section 2: Balancing

## Association of covariates with exposure group

```{r, echo = FALSE, message = FALSE, warning = FALSE, fig.width =8, fig.height=4}

barplot_association_exposure <- function(df, variable_column) {
  newplot <- df %>% 
    group_by(!!sym(variable_column), sub_cohort) %>% 
    summarise(n=n_distinct(person_id)) %>% 
    ungroup() %>% 
    group_by(sub_cohort) %>% 
    mutate(total_cohort = sum(n)) %>% 
    mutate(prop_variable =  as.numeric(n)/as.numeric(total_cohort)) %>% 
    ungroup() %>% 
    ggplot() +
    geom_bar(aes(x=!!sym(variable_column), y = prop_variable, fill=sub_cohort),stat="identity", position="dodge") +
    theme_bw() +
    theme(legend.position = "top") +
    scale_fill_brewer(palette = "Dark2") 
  
  newplot %>% return()
  
}

barplot_association_exposure_outcome <- function(df, variable_column, outcome) {
  # vis_type_col = !!visit_column
  newplot <- df %>% 
    mutate(rsv_outcome = as.character(outcome_rsv_postacute_15)) %>% 
    group_by(!!sym(variable_column), sub_cohort, rsv_outcome) %>% 
    summarise(n=n_distinct(person_id)) %>% 
    ungroup() %>% 
    group_by(sub_cohort, !!sym(variable_column)) %>% 
    mutate(total_cohort = sum(n)) %>% 
    mutate(prop_outcome =  as.numeric(n)/as.numeric(total_cohort)) %>% 
    ungroup() %>% 
    filter(rsv_outcome == "1") %>% 
    ggplot() +
    geom_bar(aes(x=!!sym(variable_column), y = prop_outcome, fill=sub_cohort),stat="identity", position="dodge") +
    theme_bw() +
    theme(legend.position = "top") +
    scale_fill_brewer(palette = "Dark2")
  
  newplot %>% return()
  
}

barplot_association_outcome <- function(df, variable_column, outcome_column) {
  # vis_type_col = !!visit_column
  newplot <- df %>% 
    mutate(outcome = !!sym(outcome_column)) %>% 
    group_by(!!sym(variable_column), outcome) %>% 
    summarise(n=n_distinct(person_id)) %>% 
    ungroup() %>% 
    group_by(!!sym(variable_column)) %>% 
    mutate(total_cohort = sum(n)) %>% 
    mutate(prop_outcome =  as.numeric(n)/as.numeric(total_cohort)) %>% 
    ungroup() %>% 
    filter(outcome == "1") %>% 
    ggplot() +
    geom_bar(aes(x=!!sym(variable_column), y = prop_outcome),stat="identity", position="dodge") +
    theme_bw() +
    theme(legend.position = "top") +
    scale_fill_brewer(palette = "Dark2")
  
  newplot %>% return()
  
}

barplot_association_outcome_weighted <- function(df, variable_column, outcome_column) {
  # vis_type_col = !!visit_column
  newplot <- df %>% 
    mutate(outcome = !!sym(outcome_column)) %>% 
    group_by(!!sym(variable_column), outcome, sub_cohort) %>% 
    summarise(n=n_distinct(person_id), n_weighted = sum(capped_iptw)) %>% 
    ungroup() %>% 
    group_by(!!sym(variable_column), sub_cohort) %>% 
    mutate(total_cohort = sum(n), total_cohort_weighted = sum(n_weighted)) %>% 
    mutate(prop_outcome =  as.numeric(n)/as.numeric(total_cohort)) %>%  
    mutate(prop_outcome_weighted =  as.numeric(n_weighted)/as.numeric(total_cohort_weighted)) %>% 
    ungroup() %>% 
    filter(outcome == "1") %>%
    select(!!sym(variable_column), sub_cohort, outcome, prop_outcome, prop_outcome_weighted) %>% 
    pivot_longer(cols = c("prop_outcome", "prop_outcome_weighted"), names_to = "outcome_sum", values_to = "proportion") %>% 
    ggplot() +
    geom_bar(aes(x=!!sym(variable_column), y = proportion, fill =sub_cohort ),stat="identity", position="dodge") +
    theme_bw() +
    facet_wrap(~outcome_sum, ncol=2) +
    theme(legend.position = "top") +
    scale_fill_brewer(palette = "Dark2")
  
  newplot %>% return()
  
}

analytic_dataset_final %>% 
  barplot_association_exposure("util_outpatient") +
  labs(x="Outpatient visits", y = "Proportion of comparison-cohort in quantile")

analytic_dataset_final %>% 
  barplot_association_exposure("util_inpatient") +
  labs(x="Inpatient visits", y = "Proportion of comparison-cohort in quantile")

analytic_dataset_final %>% 
  barplot_association_exposure("util_ed") +
  labs(x="ED visits", y = "Proportion of comparison-cohort in quantile")

analytic_dataset_final %>% 
  barplot_association_exposure("util_other") +
  labs(x="Other visits", y = "Proportion of comparison-cohort in quantile")

analytic_dataset_final %>% 
  barplot_association_exposure("hospitalized_at_index") +
  labs(x="Hospitalized at index infection event", y = "Proportion of comparison cohort")

analytic_dataset_final %>% 
  barplot_association_exposure("hospitalized_at_index_detail") +
  labs(x="Hospitalized at index infection event, detail", y = "Proportion of comparison cohort")

# analytic_dataset_final %>% 
#   barplot_association_exposure("ce_week_days_numeric") +
#   labs(x="Cohort entry week", y = "Proportion of comparison cohort")


```

<!-- ## IPTW Balance -->


<!-- ![Summary of IPTW](../results/covid_ari_util_love_plot.png) -->


<!-- ![Summary of IPTW](../results/covid_flu_util_love_plot.png) -->


<!-- ## Weighted association with exposure group -->

<!-- # Section 3: Outcomes -->


<!-- ## Association of covariates with outcome -->

<!-- Weighted and unweighted plots of association of covariates with the outcome -->


<!-- ### Outcome: RSV within 15-300 days (relaxed) -->

```{r message = FALSE, warning = FALSE, echo = FALSE, fig.width=8, fig.height=4}

# outcome = "outcome_rsv_extended"
# 
# dataset_with_iptw %>% 
#   barplot_association_outcome_weighted("util_outpatient", outcome) +
#   labs(x="Outpatient visits", y = "Proportion of group with outcome")
#        
# dataset_with_iptw %>% 
#   barplot_association_outcome_weighted("util_inpatient", outcome) +
#   labs(x="Inpatient visits", y = "Proportion of group with outcome")
# 
# dataset_with_iptw %>% 
#   barplot_association_outcome_weighted("util_ed", outcome) +
#   labs(x="ED visits", y = "Proportion of group with outcome")
# 
# dataset_with_iptw %>% 
#   barplot_association_outcome_weighted("util_other", outcome) +
#   labs(x="ED visits", y = "Proportion of group with outcome")
# 
# dataset_with_iptw %>% 
#   barplot_association_outcome_weighted("hospitalized_at_index", outcome) +
#   labs(x="Hospitalized at index infection event", y = "Proportion of comparison cohort with outcome")
# 
# dataset_with_iptw %>% 
#   barplot_association_outcome_weighted("hospitalized_at_index_detail", outcome) +
#   labs(x="Hospitalized at index infection event, detail", y = "Proportion of comparison cohort with outcome")
# 
# dataset_with_iptw %>% 
#   barplot_association_outcome_weighted("ce_week", outcome) +
#   labs(x="Cohort entry week", y = "Proportion of comparison cohort with outcome")

```

<!-- ### Outcome: RSV within 15-180 (relaxed post-acute) -->

```{r message = FALSE, warning = FALSE, echo = FALSE, fig.width=8, fig.height=4}

# outcome = "outcome_rsv_postacute_15"
# 
# dataset_with_iptw %>% 
#   barplot_association_outcome_weighted("util_outpatient", outcome) +
#   labs(x="Outpatient visits", y = "Proportion of group with outcome")
#        
# dataset_with_iptw %>% 
#   barplot_association_outcome_weighted("util_inpatient", outcome) +
#   labs(x="Inpatient visits", y = "Proportion of group with outcome")
# 
# dataset_with_iptw %>% 
#   barplot_association_outcome_weighted("util_ed", outcome) +
#   labs(x="ED visits", y = "Proportion of group with outcome")
# 
# dataset_with_iptw %>% 
#   barplot_association_outcome_weighted("util_other", outcome) +
#   labs(x="ED visits", y = "Proportion of group with outcome")
# 
# dataset_with_iptw %>% 
#   barplot_association_outcome_weighted("hospitalized_at_index", outcome) +
#   labs(x="Hospitalized at index infection event", y = "Proportion of comparison cohort with outcome")
# 
# dataset_with_iptw %>% 
#   barplot_association_outcome_weighted("hospitalized_at_index_detail", outcome) +
#   labs(x="Hospitalized at index infection event, detail", y = "Proportion of comparison cohort with outcome")
# 
# dataset_with_iptw %>% 
#   barplot_association_outcome_weighted("ce_week", outcome) +
#   labs(x="Cohort entry week", y = "Proportion of comparison cohort with outcome")

```

<!-- ### Outcome: RSV within 30-180 (strict post-acute) -->

```{r message = FALSE, warning = FALSE, echo = FALSE, fig.width=8, fig.height=4}

# outcome = "outcome_rsv_postacute_30"
# 
# dataset_with_iptw %>% 
#   barplot_association_outcome_weighted("util_outpatient", outcome) +
#   labs(x="Outpatient visits", y = "Proportion of group with outcome")
#        
# dataset_with_iptw %>% 
#   barplot_association_outcome_weighted("util_inpatient", outcome) +
#   labs(x="Inpatient visits", y = "Proportion of group with outcome")
# 
# dataset_with_iptw %>% 
#   barplot_association_outcome_weighted("util_ed", outcome) +
#   labs(x="ED visits", y = "Proportion of group with outcome")
# 
# dataset_with_iptw %>% 
#   barplot_association_outcome_weighted("util_other", outcome) +
#   labs(x="ED visits", y = "Proportion of group with outcome")
# 
# dataset_with_iptw %>% 
#   barplot_association_outcome_weighted("hospitalized_at_index", outcome) +
#   labs(x="Hospitalized at index infection event", y = "Proportion of comparison cohort with outcome")
# 
# dataset_with_iptw %>% 
#   barplot_association_outcome_weighted("hospitalized_at_index_detail", outcome) +
#   labs(x="Hospitalized at index infection event, detail", y = "Proportion of comparison cohort with outcome")
# 
# dataset_with_iptw %>% 
#   barplot_association_outcome_weighted("ce_week", outcome) +
#   labs(x="Cohort entry week", y = "Proportion of comparison cohort with outcome")

```

# Section 3: Outcomes, Frequency tables


Table 1 of outcomes:

## Aim 2: Respiratory outcomes 

### Resp outcomes with/without including covid infections

```{r echo = FALSE, warning = FALSE, message=FALSE}

outcomes_table <- analytic_dataset_final %>%
  select(person_id, outcome_resp30d, sub_cohort, resp_outcome_flu_related, resp_outcome_rsv_related, outcome_covid30d) %>% 
  mutate(outcome_resp30d = as.character(outcome_resp30d)) %>% 
  mutate(outcome_covid30d = as.character(outcome_covid30d)) %>% 
  mutate(resp_outcome_flu_related = as.character(resp_outcome_flu_related)) %>% 
  mutate(resp_outcome_rsv_related = as.character(resp_outcome_rsv_related)) %>% 
  mutate(resp30d_or_covid30d = case_when(outcome_resp30d=="1" ~ "1",
                                         outcome_covid30d=="1" ~ "1",
                                         TRUE ~ "0"))

outcomes_table_non_rsv <- outcomes_table %>% 
  filter(is.na(resp_outcome_rsv_related)) 

outcomes_table_no_reinfection <- outcomes_table %>% 
  mutate(resp_outcome_is_reinfection = case_when(resp_outcome_flu_related=="x" & sub_cohort=="Influenza" ~ "1",
                                                 outcome_covid30d=="1" & sub_cohort=="COVID" ~ "1",
                                                 TRUE ~ "0")) %>% 
  filter(resp_outcome_is_reinfection=="0")
  


table1(~ outcome_resp30d +
         resp30d_or_covid30d
         | sub_cohort,
       overall = F,
       data = outcomes_table)

```


### Respiratory infections with/without covid EXCLUDING RSV

```{r echo = FALSE, warning = FALSE, message=FALSE}

# Make second table with/without rsv, then without same-cohort re=infection, etc. Stratify

table1(~ outcome_resp30d +
         resp30d_or_covid30d
         | sub_cohort,
       overall = F,
       data = outcomes_table_non_rsv)

```

### Respiratory infections with/without covid EXCLUDING REINFECTIONS (No flu/flu or covid/covid but cross ok)

```{r echo = FALSE, warning = FALSE, message=FALSE}
table1(~ outcome_resp30d +
         resp30d_or_covid30d
         | sub_cohort,
       overall = F,
       data = outcomes_table_no_reinfection, 
       title = "Respiratory outcomes excluding re-infections")

```

## Aim 3: Outcomes for general infection

outcome_general30d does NOT include covid, but see both in table.

general30d_or_covid30d is the main outcome including covid or general infection.

```{r echo = FALSE, warning = FALSE, message=FALSE}

outcomes_table <- analytic_dataset_final %>%
  select(person_id, outcome_resp30d, sub_cohort, resp_outcome_flu_related, resp_outcome_rsv_related, outcome_covid30d, outcome_general30d) %>% 
  mutate(outcome_resp30d = as.character(outcome_resp30d)) %>% 
  mutate(outcome_covid30d = as.character(outcome_covid30d)) %>% 
  mutate(outcome_general30d = as.character(outcome_general30d)) %>% 
  mutate(resp_outcome_flu_related = as.character(resp_outcome_flu_related)) %>% 
  mutate(resp_outcome_rsv_related = as.character(resp_outcome_rsv_related)) %>% 
  mutate(general30d_or_covid30d = case_when(outcome_general30d=="1" ~ "1",
                                         outcome_covid30d=="1" ~ "1",
                                         TRUE ~ "0"))

table1(~ outcome_resp30d +
         general30d_or_covid30d +
         outcome_covid30d +
         outcome_general30d 
         | sub_cohort,
       overall = F,
       data = outcomes_table)

# Make second table with/without rsv, then without same-cohort re=infection, etc. Stratify

# TODO next: modeling for general infections!
```

<!-- Compare weighted and unweighted models of the outcome: -->

<!-- ### Outcome: RSV within 15-300 days (past post-acute) -->

<!-- ## Outcome model -->

<!-- ```{r echo = FALSE, output = FALSE, message = FALSE , warning = FALSE} -->

<!-- outcome = "outcome_rsv_15_to_300" -->
<!-- comparison_group = comparison_group_string -->

<!-- iptw_flu <- analytic_dataset_final %>% -->
<!--   mutate(exclude = case_when( is.na(days_from_index_to_rsv) ~ 0, -->
<!--                               days_from_index_to_rsv >= 15 ~ 0, -->
<!--                               TRUE ~ 1)) %>%  -->
<!--   filter(exclude==0) %>%  -->
<!--   do_iptw(cohort_entry_start_date = cohort_entry_start_date, -->
<!--           comparison_cohort = comparison_group, -->
<!--           weight_formula = "covid~age_group+sex_cat+race_eth_cat+ce_week_factor", -->
<!--           iptw_description = paste0("covid_", comparison_group, "_", outcome)) -->

<!-- iptw_flu$love_plot -->

<!-- dataset_with_iptw <- results_tbl( paste0(paste0("covid_", comparison_group, "_", outcome),'_tabc')) -->
<!-- models = list() -->

<!-- models$model_unweighted_unadjusted <- run_logistic_regression(df = dataset_with_iptw, -->
<!--                                                        model_formula = paste0(outcome, " ~ covid"), -->
<!--                                                        weight_method = "none") -->

<!-- models$model_unweighted_adjusted <- run_logistic_regression(df = dataset_with_iptw, -->
<!--                                                          model_formula = paste0(outcome, -->
<!--                                                                                 " ~ covid + race_eth_cat + age_group + sex_cat + hospitalized_at_index + util_ed + util_inpatient + util_outpatient + util_other"), -->
<!--                                                          weight_method = "none") -->

<!-- models$model_weighted_unadjusted <- run_logistic_regression(df = dataset_with_iptw, -->
<!--                                                        model_formula = paste0(outcome, " ~ covid"), -->
<!--                                                        weight_method = "lr") -->

<!-- models$model_weighted_adjusted <- run_logistic_regression(df = dataset_with_iptw, -->
<!--                                                          model_formula = paste0(outcome, -->
<!--                                                                                 " ~ covid + race_eth_cat + age_group + sex_cat + hospitalized_at_index + util_ed + util_inpatient + util_outpatient + util_other"), -->
<!--                                                          weight_method = "lr") -->

<!-- models$model_weighted_adjusted_time <- run_logistic_regression(df = dataset_with_iptw, -->
<!--                                                          model_formula = paste0(outcome, -->
<!--                                                                                 " ~ covid + race_eth_cat + age_group + sex_cat + hospitalized_at_index + util_ed + util_inpatient + util_outpatient + util_other + ce_week_factor"), -->
<!--                                                          weight_method = "lr") -->

<!-- ``` -->

<!-- ```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width=12, fig.height=6} -->

<!-- plot_summs(models$model_unweighted_unadjusted, -->
<!--            models$model_unweighted_adjusted, -->
<!--            models$model_weighted_unadjusted, -->
<!--            models$model_weighted_adjusted, -->
<!--            # models$model_weighted_adjusted_time, -->
<!--            model.names = c("Unweighted, unadjusted", -->
<!--                            "Unweighted, adjusted", -->
<!--                            "Weighted (LR), unadjusted", -->
<!--                            "Weighted (LR), adjusted"), -->
<!--                            # "Weighted, adjusted for CE week"),  -->
<!--            exp = TRUE) -->

<!-- ``` -->


<!-- ### Outcome: RSV within 15-180 (relaxed post-acute) -->

<!-- ```{r echo = FALSE, output = FALSE, message = FALSE , warning = FALSE} -->

<!-- outcome = "outcome_rsv_15_to_180" -->
<!-- comparison_group = comparison_group_string -->

<!-- iptw_flu <- analytic_dataset_final %>% -->
<!--   mutate(exclude = case_when( is.na(days_from_index_to_rsv) ~ 0, -->
<!--                               days_from_index_to_rsv >= 15 ~ 0, -->
<!--                               TRUE ~ 1)) %>%  -->
<!--   filter(exclude==0) %>%  -->
<!--   do_iptw(cohort_entry_start_date = cohort_entry_start_date, -->
<!--           comparison_cohort = comparison_group, -->
<!--           weight_formula = "covid~age_group+sex_cat+race_eth_cat+ce_week_factor", -->
<!--           iptw_description = paste0("covid_", comparison_group, "_", outcome)) -->

<!-- iptw_flu$love_plot -->

<!-- dataset_with_iptw <- results_tbl( paste0(paste0("covid_", comparison_group, "_", outcome),'_tabc')) -->


<!-- models = list() -->

<!-- models$model_unweighted_unadjusted <- run_logistic_regression(df = dataset_with_iptw, -->
<!--                                                        model_formula = paste0(outcome, " ~ covid"), -->
<!--                                                        weight_method = "none") -->

<!-- models$model_unweighted_adjusted <- run_logistic_regression(df = dataset_with_iptw, -->
<!--                                                          model_formula = paste0(outcome, -->
<!--                                                                                 " ~ covid + race_eth_cat + age_group + sex_cat + hospitalized_at_index + util_ed + util_inpatient + util_outpatient + util_other"), -->
<!--                                                          weight_method = "none") -->

<!-- models$model_weighted_unadjusted <- run_logistic_regression(df = dataset_with_iptw, -->
<!--                                                        model_formula = paste0(outcome, " ~ covid"), -->
<!--                                                        weight_method = "lr") -->

<!-- models$model_weighted_adjusted <- run_logistic_regression(df = dataset_with_iptw, -->
<!--                                                          model_formula = paste0(outcome, -->
<!--                                                                                 " ~ covid + race_eth_cat + age_group + sex_cat + hospitalized_at_index + util_ed + util_inpatient + util_outpatient + util_other"), -->
<!--                                                          weight_method = "lr") -->

<!-- models$model_weighted_adjusted_time <- run_logistic_regression(df = dataset_with_iptw, -->
<!--                                                          model_formula = paste0(outcome, -->
<!--                                                                                 " ~ covid + race_eth_cat + age_group + sex_cat + hospitalized_at_index + util_ed + util_inpatient + util_outpatient + util_other + ce_week_factor"), -->
<!--                                                          weight_method = "lr") -->

<!-- ``` -->

<!-- ```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width=12, fig.height=6} -->

<!-- plot_summs(models$model_unweighted_unadjusted, -->
<!--            models$model_unweighted_adjusted, -->
<!--            models$model_weighted_unadjusted, -->
<!--            models$model_weighted_adjusted, -->
<!--            # models$model_weighted_adjusted_time, -->
<!--            model.names = c("Unweighted, unadjusted", -->
<!--                            "Unweighted, adjusted", -->
<!--                            "Weighted (LR), unadjusted", -->
<!--                            "Weighted (LR), adjusted"), -->
<!--                            # "Weighted, adjusted for CE weeanalytic_dataset_finalk"),  -->
<!--            exp = TRUE) -->

<!-- export_summs(models$model_unweighted_unadjusted, -->
<!--            models$model_unweighted_adjusted, -->
<!--            models$model_weighted_unadjusted, -->
<!--            models$model_weighted_adjusted, -->
<!--            # models$model_weighted_adjusted_time, -->
<!--            model.names = c("Unweighted, unadjusted", -->
<!--                            "Unweighted, adjusted", -->
<!--                            "Weighted, unadjusted", -->
<!--                            "Weighted, adjusted"), -->
<!--                            # "Weighted, adjusted for CE weeanalytic_dataset_finalk"),  -->
<!--            exp = TRUE) -->

<!-- ``` -->

<!-- ### Outcome: RSV within 1-60 days -->


<!-- ```{r echo = FALSE, output = FALSE, message = FALSE , warning = FALSE} -->

<!-- outcome = "outcome_rsv_1_to_60" -->
<!-- comparison_group = comparison_group_string -->

<!-- iptw_flu <- analytic_dataset_final %>% -->
<!--   mutate(exclude = case_when( is.na(days_from_index_to_rsv) ~ 0, -->
<!--                               days_from_index_to_rsv >= 1 ~ 0, -->
<!--                               TRUE ~ 1)) %>%  -->
<!--   filter(exclude==0) %>%  -->
<!--   do_iptw(cohort_entry_start_date = cohort_entry_start_date, -->
<!--           comparison_cohort = comparison_group, -->
<!--           weight_formula = "covid~age_group+sex_cat+race_eth_cat+ce_week_factor", -->
<!--           iptw_description = paste0("covid_", comparison_group, "_", outcome)) -->

<!-- iptw_flu$love_plot -->

<!-- dataset_with_iptw <- results_tbl( paste0(paste0("covid_", comparison_group, "_", outcome),'_tabc')) %>%  -->
<!--   collect() -->


<!-- models = list() -->

<!-- models$model_unweighted_unadjusted <- run_logistic_regression(df = dataset_with_iptw, -->
<!--                                                        model_formula = paste0(outcome, " ~ covid"), -->
<!--                                                        weight_method = "none") -->

<!-- models$model_unweighted_adjusted <- run_logistic_regression(df = dataset_with_iptw, -->
<!--                                                          model_formula = paste0(outcome, -->
<!--                                                                                 " ~ covid + race_eth_cat + age_group + sex_cat + hospitalized_at_index + util_ed + util_inpatient + util_outpatient + util_other"), -->
<!--                                                          weight_method = "none") -->

<!-- models$model_weighted_unadjusted <- run_logistic_regression(df = dataset_with_iptw, -->
<!--                                                        model_formula = paste0(outcome, " ~ covid"), -->
<!--                                                        weight_method = "lr") -->

<!-- models$model_weighted_adjusted <- run_logistic_regression(df = dataset_with_iptw, -->
<!--                                                          model_formula = paste0(outcome, -->
<!--                                                                                 " ~ covid + race_eth_cat + age_group + sex_cat + hospitalized_at_index + util_ed + util_inpatient + util_outpatient + util_other"), -->
<!--                                                          weight_method = "lr") -->

<!-- models$model_weighted_adjusted_time <- run_logistic_regression(df = dataset_with_iptw, -->
<!--                                                          model_formula = paste0(outcome, -->
<!--                                                                                 " ~ covid + race_eth_cat + age_group + sex_cat + hospitalized_at_index + util_ed + util_inpatient + util_outpatient + util_other + ce_week_factor"), -->
<!--                                                          weight_method = "lr") -->

<!-- ``` -->

<!-- ```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width=12, fig.height=6} -->

<!-- plot_summs(models$model_unweighted_unadjusted, -->
<!--            models$model_unweighted_adjusted, -->
<!--            models$model_weighted_unadjusted, -->
<!--            models$model_weighted_adjusted, -->
<!--            # models$model_weighted_adjusted_time, -->
<!--            model.names = c("Unweighted, unadjusted", -->
<!--                            "Unweighted, adjusted", -->
<!--                            "Weighted (LR), unadjusted", -->
<!--                            "Weighted (LR), adjusted"), -->
<!--                            # "Weighted, adjusted for CE week"),  -->
<!--            exp = TRUE) -->

<!-- export_summs(models$model_unweighted_unadjusted, -->
<!--            models$model_unweighted_adjusted, -->
<!--            models$model_weighted_unadjusted, -->
<!--            models$model_weighted_adjusted, -->
<!--            # models$model_weighted_adjusted_time, -->
<!--            model.names = c("Unweighted, unadjusted", -->
<!--                            "Unweighted, adjusted", -->
<!--                            "Weighted (LR), unadjusted", -->
<!--                            "Weighted (LR), adjusted"), -->
<!--                            # "Weighted, adjusted for CE week"),  -->
<!--            exp = TRUE) -->

<!-- ``` -->

<!-- ### Outcome: RSV within 0-60 days -->


<!-- ```{r echo = FALSE, output = FALSE, message = FALSE , warning = FALSE} -->

<!-- outcome = "outcome_rsv_0_to_60" -->
<!-- comparison_group = comparison_group_string -->

<!-- iptw_flu <- analytic_dataset_final %>% -->
<!--   do_iptw(cohort_entry_start_date = cohort_entry_start_date, -->
<!--           comparison_cohort = comparison_group, -->
<!--           weight_formula = "covid~age_group+sex_cat+race_eth_cat+ce_week_factor", -->
<!--           iptw_description = paste0("covid_", comparison_group, "_", outcome)) -->

<!-- iptw_flu$love_plot -->

<!-- dataset_with_iptw <- results_tbl( paste0(paste0("covid_", comparison_group, "_", outcome),'_tabc')) %>%  -->
<!--   collect() -->


<!-- models = list() -->

<!-- models$model_unweighted_unadjusted <- run_logistic_regression(df = dataset_with_iptw, -->
<!--                                                        model_formula = paste0(outcome, " ~ covid"), -->
<!--                                                        weight_method = "none") -->

<!-- models$model_unweighted_adjusted <- run_logistic_regression(df = dataset_with_iptw, -->
<!--                                                          model_formula = paste0(outcome, -->
<!--                                                                                 " ~ covid + race_eth_cat + age_group + sex_cat + hospitalized_at_index + util_ed + util_inpatient + util_outpatient + util_other"), -->
<!--                                                          weight_method = "none") -->

<!-- models$model_weighted_unadjusted <- run_logistic_regression(df = dataset_with_iptw, -->
<!--                                                        model_formula = paste0(outcome, " ~ covid"), -->
<!--                                                        weight_method = "lr") -->

<!-- models$model_weighted_adjusted <- run_logistic_regression(df = dataset_with_iptw, -->
<!--                                                          model_formula = paste0(outcome, -->
<!--                                                                                 " ~ covid + race_eth_cat + age_group + sex_cat + hospitalized_at_index + util_ed + util_inpatient + util_outpatient + util_other"), -->
<!--                                                          weight_method = "lr") -->



<!-- models$model_weighted_adjusted_time <- run_logistic_regression(df = dataset_with_iptw, -->
<!--                                                          model_formula = paste0(outcome, -->
<!--                                                                                 " ~ covid + race_eth_cat + age_group + sex_cat + hospitalized_at_index + util_ed + util_inpatient + util_outpatient + util_other + ce_week_factor"), -->
<!--                                                          weight_method = "lr") -->

<!-- ``` -->

<!-- ```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width=12, fig.height=6} -->

<!-- plot_summs(models$model_unweighted_unadjusted, -->
<!--            models$model_unweighted_adjusted, -->
<!--            models$model_weighted_unadjusted, -->
<!--            models$model_weighted_adjusted, -->
<!--            # models$model_weighted_adjusted_time, -->
<!--            model.names = c("Unweighted, unadjusted", -->
<!--                            "Unweighted, adjusted", -->
<!--                            "Weighted (LR), unadjusted", -->
<!--                            "Weighted (LR), adjusted"), -->
<!--                            # "Weighted, adjusted for CE week"),  -->
<!--            exp = TRUE) -->

<!-- export_summs(models$model_unweighted_unadjusted, -->
<!--            models$model_unweighted_adjusted, -->
<!--            models$model_weighted_unadjusted, -->
<!--            models$model_weighted_adjusted, -->
<!--            # models$model_weighted_adjusted_time, -->
<!--            model.names = c("Unweighted, unadjusted", -->
<!--                            "Unweighted, adjusted", -->
<!--                            "Weighted (LR), unadjusted", -->
<!--                            "Weighted (LR), adjusted"), -->
<!--                            # "Weighted, adjusted for CE week"),  -->
<!--            exp = TRUE) -->

<!-- ``` -->

<!-- ### Outcome: RSV on same day as index event -->


<!-- ```{r echo = FALSE, output = FALSE, message = FALSE , warning = FALSE} -->

<!-- outcome = "outcome_rsv_same_day" -->
<!-- comparison_group = comparison_group_string -->

<!-- iptw_flu <- analytic_dataset_final %>% -->
<!--   do_iptw(cohort_entry_start_date = cohort_entry_start_date, -->
<!--           comparison_cohort = comparison_group, -->
<!--           weight_formula = "covid~age_group+sex_cat+race_eth_cat+ce_week_factor", -->
<!--           iptw_description = paste0("covid_", comparison_group, "_", outcome)) -->

<!-- iptw_flu$love_plot -->

<!-- dataset_with_iptw <- results_tbl( paste0(paste0("covid_", comparison_group, "_", outcome),'_tabc')) %>%  -->
<!--   collect() -->


<!-- models = list() -->

<!-- models$model_unweighted_unadjusted <- run_logistic_regression(df = dataset_with_iptw, -->
<!--                                                        model_formula = paste0(outcome, " ~ covid"), -->
<!--                                                        weight_method = "none") -->

<!-- models$model_unweighted_adjusted <- run_logistic_regression(df = dataset_with_iptw, -->
<!--                                                          model_formula = paste0(outcome, -->
<!--                                                                                 " ~ covid + race_eth_cat + age_group + sex_cat + hospitalized_at_index + util_ed + util_inpatient + util_outpatient + util_other"), -->
<!--                                                          weight_method = "none") -->

<!-- models$model_weighted_unadjusted <- run_logistic_regression(df = dataset_with_iptw, -->
<!--                                                        model_formula = paste0(outcome, " ~ covid"), -->
<!--                                                        weight_method = "lr") -->

<!-- models$model_weighted_adjusted <- run_logistic_regression(df = dataset_with_iptw, -->
<!--                                                          model_formula = paste0(outcome, -->
<!--                                                                                 " ~ covid + race_eth_cat + age_group + sex_cat + hospitalized_at_index + util_ed + util_inpatient + util_outpatient + util_other"), -->
<!--                                                          weight_method = "lr") -->

<!-- models$model_weighted_adjusted_time <- run_logistic_regression(df = dataset_with_iptw, -->
<!--                                                          model_formula = paste0(outcome, -->
<!--                                                                                 " ~ covid + race_eth_cat + age_group + sex_cat + hospitalized_at_index + util_ed + util_inpatient + util_outpatient + util_other + ce_week_factor"), -->
<!--                                                          weight_method = "lr") -->

<!-- ``` -->

<!-- ```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width=12, fig.height=6} -->

<!-- plot_summs(models$model_unweighted_unadjusted, -->
<!--            models$model_unweighted_adjusted, -->
<!--            models$model_weighted_unadjusted, -->
<!--            models$model_weighted_adjusted, -->
<!--            # models$model_weighted_adjusted_time, -->
<!--            model.names = c("Unweighted, unadjusted", -->
<!--                            "Unweighted, adjusted", -->
<!--                            "Weighted (LR), unadjusted", -->
<!--                            "Weighted (LR), adjusted"), -->
<!--                            # "Weighted, adjusted for CE week"),  -->
<!--            exp = TRUE) -->

<!-- export_summs(models$model_unweighted_unadjusted, -->
<!--            models$model_unweighted_adjusted, -->
<!--            models$model_weighted_unadjusted, -->
<!--            models$model_weighted_adjusted, -->
<!--            # models$model_weighted_adjusted_time, -->
<!--            model.names = c("Unweighted, unadjusted", -->
<!--                            "Unweighted, adjusted", -->
<!--                            "Weighted (LR), unadjusted", -->
<!--                            "Weighted (LR), adjusted"), -->
<!--                            # "Weighted, adjusted for CE week"),  -->
<!--            exp = TRUE) -->

<!-- ``` -->


# Section 4: Modeling
                                         
## Aim 2: Outcome: Subsequent Respiratory infection within 30-180 days

### Including covid, or flu, ANY respiratory infection within 30-180 days.


```{r echo = FALSE, output = FALSE, message = FALSE , warning = FALSE}

# TODO really need to figure out what the deal with utilization is
outcome = "resp30d_or_covid30d"
comparison_group = comparison_group_string

iptw_flu <- analytic_dataset_final %>%
  filter(resp_outcome_is_reinfection=="0") %>% # TODO allow for re-infection
  mutate(resp30d_or_covid30d = case_when(outcome_resp30d==1 ~ 1,
                                         outcome_covid30d==1 ~ 1,
                                         TRUE ~ 0)) %>% 
  do_iptw(cohort_entry_start_date = cohort_entry_start_date,
          comparison_cohort = comparison_group,
          weight_formula = "covid~age_group+sex_cat+race_eth_cat+ce_week_factor",
          iptw_description = paste0("resp_stdy_covid_", comparison_group, "_", outcome))

iptw_flu$love_plot

dataset_with_iptw <- results_tbl( paste0(paste0("resp_stdy_covid_", comparison_group, "_", outcome),'_tabc')) %>%
  collect()


models = list()

models$model_unweighted_unadjusted <- run_logistic_regression(df = dataset_with_iptw,
                                                       model_formula = paste0(outcome, " ~ covid"),
                                                       weight_method = "none")

models$model_unweighted_adjusted <- run_logistic_regression(df = dataset_with_iptw,
                                                         model_formula = paste0(outcome,
                                                                                " ~ covid + race_eth_cat + age_group + sex_cat + hospitalized_at_index + util_ed + util_outpatient + util_other"),
                                                         weight_method = "none")

models$model_weighted_unadjusted <- run_logistic_regression(df = dataset_with_iptw,
                                                       model_formula = paste0(outcome, " ~ covid"),
                                                       weight_method = "lr")

# TODO something is wrong with inpatient
models$model_weighted_adjusted <- run_logistic_regression(df = dataset_with_iptw,
                                                         model_formula = paste0(outcome,
                                                                                " ~ covid + race_eth_cat + age_group + sex_cat + hospitalized_at_index + util_ed + util_outpatient + util_other"),
                                                         weight_method = "lr")

models$model_weighted_adjusted_time <- run_logistic_regression(df = dataset_with_iptw,
                                                         model_formula = paste0(outcome,
                                                                                " ~ covid + race_eth_cat + age_group + sex_cat + hospitalized_at_index + util_ed + util_outpatient + util_other + ce_week_factor"),
                                                         weight_method = "lr")

```

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width=12, fig.height=6}

plot_summs(models$model_unweighted_unadjusted,
           models$model_unweighted_adjusted,
           models$model_weighted_unadjusted,
           models$model_weighted_adjusted,
           # models$model_weighted_adjusted_time,
           model.names = c("Unweighted, unadjusted",
                           "Unweighted, adjusted",
                           "Weighted (LR), unadjusted",
                           "Weighted (LR), adjusted"),
                           # "Weighted, adjusted for CE week"),
           exp = TRUE)

export_summs(models$model_unweighted_unadjusted,
           models$model_unweighted_adjusted,
           models$model_weighted_unadjusted,
           models$model_weighted_adjusted,
           # models$model_weighted_adjusted_time,
           model.names = c("Unweighted, unadjusted",
                           "Unweighted, adjusted",
                           "Weighted (LR), unadjusted",
                           "Weighted (LR), adjusted"),
                           # "Weighted, adjusted for CE week"),
           exp = TRUE)

```

### Outcome: Subsequent Respiratory infection within 30-180 days, EXCLUDING COVID


```{r echo = FALSE, output = FALSE, message = FALSE , warning = FALSE}

# TODO really need to figure out what the deal with utilization is
outcome = "outcome_resp30d"
comparison_group = comparison_group_string

iptw_flu <- analytic_dataset_final %>%
  filter(resp_outcome_is_reinfection=="0") %>% # TODO allow for re-infection
  do_iptw(cohort_entry_start_date = cohort_entry_start_date,
          comparison_cohort = comparison_group,
          weight_formula = "covid~age_group+sex_cat+race_eth_cat+ce_week_factor",
          iptw_description = paste0("resp_stdy_covid_", comparison_group, "_", outcome))

iptw_flu$love_plot

dataset_with_iptw <- results_tbl( paste0(paste0("resp_stdy_covid_", comparison_group, "_", outcome),'_tabc')) %>%
  collect()


models = list()

models$model_unweighted_unadjusted <- run_logistic_regression(df = dataset_with_iptw,
                                                       model_formula = paste0(outcome, " ~ covid"),
                                                       weight_method = "none")

models$model_unweighted_adjusted <- run_logistic_regression(df = dataset_with_iptw,
                                                         model_formula = paste0(outcome,
                                                                                " ~ covid + race_eth_cat + age_group + sex_cat + hospitalized_at_index + util_ed + util_outpatient + util_other"),
                                                         weight_method = "none")

models$model_weighted_unadjusted <- run_logistic_regression(df = dataset_with_iptw,
                                                       model_formula = paste0(outcome, " ~ covid"),
                                                       weight_method = "lr")

# TODO something is wrong with inpatient
models$model_weighted_adjusted <- run_logistic_regression(df = dataset_with_iptw,
                                                         model_formula = paste0(outcome,
                                                                                " ~ covid + race_eth_cat + age_group + sex_cat + hospitalized_at_index + util_ed + util_outpatient + util_other"),
                                                         weight_method = "lr")

models$model_weighted_adjusted_time <- run_logistic_regression(df = dataset_with_iptw,
                                                         model_formula = paste0(outcome,
                                                                                " ~ covid + race_eth_cat + age_group + sex_cat + hospitalized_at_index + util_ed + util_outpatient + util_other + ce_week_factor"),
                                                         weight_method = "lr")

```

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width=12, fig.height=6}

plot_summs(models$model_unweighted_unadjusted,
           models$model_unweighted_adjusted,
           models$model_weighted_unadjusted,
           models$model_weighted_adjusted,
           # models$model_weighted_adjusted_time,
           model.names = c("Unweighted, unadjusted",
                           "Unweighted, adjusted",
                           "Weighted (LR), unadjusted",
                           "Weighted (LR), adjusted"),
                           # "Weighted, adjusted for CE week"),
           exp = TRUE)

export_summs(models$model_unweighted_unadjusted,
           models$model_unweighted_adjusted,
           models$model_weighted_unadjusted,
           models$model_weighted_adjusted,
           # models$model_weighted_adjusted_time,
           model.names = c("Unweighted, unadjusted",
                           "Unweighted, adjusted",
                           "Weighted (LR), unadjusted",
                           "Weighted (LR), adjusted"),
                           # "Weighted, adjusted for CE week"),
           exp = TRUE)

```

## Aim 3: General/any infection

### Outcome: Subsequent General/Any infection within 30-180 days

Including covid, or flu, ANY infection within 30-180 days.


```{r echo = FALSE, output = FALSE, message = FALSE , warning = FALSE}

# TODO really need to figure out what the deal with utilization is
outcome = "general30d_or_covid30d"
comparison_group = comparison_group_string

iptw_flu <- analytic_dataset_final %>%
  filter(resp_outcome_is_reinfection=="0") %>% # TODO allow for re-infection
  mutate(general30d_or_covid30d = case_when(outcome_general30d==1 ~ 1,
                                         outcome_covid30d==1 ~ 1,
                                         TRUE ~ 0)) %>% 
  do_iptw(cohort_entry_start_date = cohort_entry_start_date,
          comparison_cohort = comparison_group,
          weight_formula = "covid~age_group+sex_cat+race_eth_cat+ce_week_factor",
          iptw_description = paste0("resp_stdy_covid_", comparison_group, "_", outcome))

iptw_flu$love_plot

dataset_with_iptw <- results_tbl( paste0(paste0("resp_stdy_covid_", comparison_group, "_", outcome),'_tabc')) %>%
  collect()


models = list()

models$model_unweighted_unadjusted <- run_logistic_regression(df = dataset_with_iptw,
                                                       model_formula = paste0(outcome, " ~ covid"),
                                                       weight_method = "none")

models$model_unweighted_adjusted <- run_logistic_regression(df = dataset_with_iptw,
                                                         model_formula = paste0(outcome,
                                                                                " ~ covid + race_eth_cat + age_group + sex_cat + hospitalized_at_index + util_ed + util_outpatient + util_other"),
                                                         weight_method = "none")

models$model_weighted_unadjusted <- run_logistic_regression(df = dataset_with_iptw,
                                                       model_formula = paste0(outcome, " ~ covid"),
                                                       weight_method = "lr")

# TODO something is wrong with inpatient
models$model_weighted_adjusted <- run_logistic_regression(df = dataset_with_iptw,
                                                         model_formula = paste0(outcome,
                                                                                " ~ covid + race_eth_cat + age_group + sex_cat + hospitalized_at_index + util_ed + util_outpatient + util_other"),
                                                         weight_method = "lr")

models$model_weighted_adjusted_time <- run_logistic_regression(df = dataset_with_iptw,
                                                         model_formula = paste0(outcome,
                                                                                " ~ covid + race_eth_cat + age_group + sex_cat + hospitalized_at_index + util_ed + util_outpatient + util_other + ce_week_factor"),
                                                         weight_method = "lr")

```

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width=12, fig.height=6}

plot_summs(models$model_unweighted_unadjusted,
           models$model_unweighted_adjusted,
           models$model_weighted_unadjusted,
           models$model_weighted_adjusted,
           # models$model_weighted_adjusted_time,
           model.names = c("Unweighted, unadjusted",
                           "Unweighted, adjusted",
                           "Weighted (LR), unadjusted",
                           "Weighted (LR), adjusted"),
                           # "Weighted, adjusted for CE week"),
           exp = TRUE)

export_summs(models$model_unweighted_unadjusted,
           models$model_unweighted_adjusted,
           models$model_weighted_unadjusted,
           models$model_weighted_adjusted,
           # models$model_weighted_adjusted_time,
           model.names = c("Unweighted, unadjusted",
                           "Unweighted, adjusted",
                           "Weighted (LR), unadjusted",
                           "Weighted (LR), adjusted"),
                           # "Weighted, adjusted for CE week"),
           exp = TRUE)
```


### Outcome: Subsequent General (any) infection within 30-180 days (exlcuding covid)


```{r echo = FALSE, output = FALSE, message = FALSE , warning = FALSE}

# TODO really need to figure out what the deal with utilization is
outcome = "outcome_general30d"
comparison_group = comparison_group_string

iptw_flu <- analytic_dataset_final %>%
  filter(resp_outcome_is_reinfection=="0") %>% # TODO allow for re-infection
  do_iptw(cohort_entry_start_date = cohort_entry_start_date,
          comparison_cohort = comparison_group,
          weight_formula = "covid~age_group+sex_cat+race_eth_cat+ce_week_factor",
          iptw_description = paste0("resp_stdy_covid_", comparison_group, "_", outcome))

iptw_flu$love_plot

dataset_with_iptw <- results_tbl( paste0(paste0("resp_stdy_covid_", comparison_group, "_", outcome),'_tabc')) %>%
  collect()


models = list()

models$model_unweighted_unadjusted <- run_logistic_regression(df = dataset_with_iptw,
                                                       model_formula = paste0(outcome, " ~ covid"),
                                                       weight_method = "none")

models$model_unweighted_adjusted <- run_logistic_regression(df = dataset_with_iptw,
                                                         model_formula = paste0(outcome,
                                                                                " ~ covid + race_eth_cat + age_group + sex_cat + hospitalized_at_index + util_ed + util_outpatient + util_other"),
                                                         weight_method = "none")

models$model_weighted_unadjusted <- run_logistic_regression(df = dataset_with_iptw,
                                                       model_formula = paste0(outcome, " ~ covid"),
                                                       weight_method = "lr")

# TODO something is wrong with inpatient
models$model_weighted_adjusted <- run_logistic_regression(df = dataset_with_iptw,
                                                         model_formula = paste0(outcome,
                                                                                " ~ covid + race_eth_cat + age_group + sex_cat + hospitalized_at_index + util_ed + util_outpatient + util_other"),
                                                         weight_method = "lr")

models$model_weighted_adjusted_time <- run_logistic_regression(df = dataset_with_iptw,
                                                         model_formula = paste0(outcome,
                                                                                " ~ covid + race_eth_cat + age_group + sex_cat + hospitalized_at_index + util_ed + util_outpatient + util_other + ce_week_factor"),
                                                         weight_method = "lr")

```

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width=12, fig.height=6}

plot_summs(models$model_unweighted_unadjusted,
           models$model_unweighted_adjusted,
           models$model_weighted_unadjusted,
           models$model_weighted_adjusted,
           # models$model_weighted_adjusted_time,
           model.names = c("Unweighted, unadjusted",
                           "Unweighted, adjusted",
                           "Weighted (LR), unadjusted",
                           "Weighted (LR), adjusted"),
                           # "Weighted, adjusted for CE week"),
           exp = TRUE)

export_summs(models$model_unweighted_unadjusted,
           models$model_unweighted_adjusted,
           models$model_weighted_unadjusted,
           models$model_weighted_adjusted,
           # models$model_weighted_adjusted_time,
           model.names = c("Unweighted, unadjusted",
                           "Unweighted, adjusted",
                           "Weighted (LR), unadjusted",
                           "Weighted (LR), adjusted"),
                           # "Weighted, adjusted for CE week"),
           exp = TRUE)

```

<!-- ### Figure for paper -->

<!-- Comparing multiple different outcome models in same figure? -->

<!-- Models to compare:  -->
<!-- Outcome: 15-180 RSV, 1-60 RSV, 0-60 RSV -->
<!-- Adjustments: None, weighted/adjusted -->

<!-- ```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width=12, fig.height=6} -->


<!-- models = list() -->

<!-- outcome_0_60 = "outcome_rsv_0_to_60" -->
<!-- comparison_group = comparison_group_string -->

<!-- iptw_0_60 <- analytic_dataset_final %>% -->
<!--   do_iptw(cohort_entry_start_date = cohort_entry_start_date, -->
<!--           comparison_cohort = comparison_group, -->
<!--           weight_formula = "covid~age_group+sex_cat+race_eth_cat+ce_week_factor", -->
<!--           iptw_description = paste0("covid_", comparison_group, "_", outcome_0_60)) -->

<!-- df_0_60 <- results_tbl( paste0(paste0("covid_", comparison_group, "_", outcome_0_60),'_tabc')) %>%  -->
<!--   collect() -->

<!-- models$unw_unadj_0_to_60 <- run_logistic_regression(df = df_0_60, -->
<!--                                                        model_formula = paste0(outcome_0_60, " ~ covid"), -->
<!--                                                        weight_method = "none") -->

<!-- models$w_adj_0_to_60 <- run_logistic_regression(df = df_0_60, -->
<!--                                                          model_formula = paste0(outcome_0_60, -->
<!--                                                                                 " ~ covid + age_group + hospitalized_at_index + util_inpatient"), -->
<!--                                                          weight_method = "lr") -->

<!-- ### -->
<!-- outcome_1_60 = "outcome_rsv_1_to_60" -->
<!-- comparison_group = comparison_group_string -->

<!-- iptw_1_60 <- analytic_dataset_final %>% -->
<!--   do_iptw(cohort_entry_start_date = cohort_entry_start_date, -->
<!--           comparison_cohort = comparison_group, -->
<!--           weight_formula = "covid~age_group+sex_cat+race_eth_cat+ce_week_factor", -->
<!--           iptw_description = paste0("covid_", comparison_group, "_", outcome_1_60)) -->

<!-- df_1_60 <- results_tbl( paste0(paste0("covid_", comparison_group, "_", outcome_1_60),'_tabc')) %>%  -->
<!--   collect() -->

<!-- models$unw_unadj_1_to_60 <- run_logistic_regression(df = df_1_60, -->
<!--                                                        model_formula = paste0(outcome_1_60, " ~ covid"), -->
<!--                                                        weight_method = "none") -->

<!-- models$w_adj_1_to_60 <- run_logistic_regression(df = df_1_60, -->
<!--                                                          model_formula = paste0(outcome_1_60, -->
<!--                                                                                 " ~ covid + age_group + hospitalized_at_index + util_inpatient"), -->
<!--                                                          weight_method = "lr") -->

<!-- ## -->
<!-- outcome_15_180 = "outcome_rsv_15_to_180" -->
<!-- comparison_group = comparison_group_string -->

<!-- iptw_15_180 <- analytic_dataset_final %>% -->
<!--   do_iptw(cohort_entry_start_date = cohort_entry_start_date, -->
<!--           comparison_cohort = comparison_group, -->
<!--           weight_formula = "covid~age_group+sex_cat+race_eth_cat+ce_week_factor", -->
<!--           iptw_description = paste0("covid_", comparison_group, "_", outcome_15_180)) -->

<!-- df_15_180 <- results_tbl( paste0(paste0("covid_", comparison_group, "_", outcome_15_180),'_tabc')) %>%  -->
<!--   collect() -->

<!-- models$unw_unadj_15_to_180 <- run_logistic_regression(df = df_15_180, -->
<!--                                                        model_formula = paste0(outcome_15_180, " ~ covid"), -->
<!--                                                        weight_method = "none") -->

<!-- models$w_adj_15_to_180 <- run_logistic_regression(df = df_15_180, -->
<!--                                                          model_formula = paste0(outcome_15_180, -->
<!--                                                                                 " ~ covid + age_group + hospitalized_at_index + util_inpatient"), -->
<!--                                                          weight_method = "lr") -->


<!-- plot_summs(models$unw_unadj_0_to_60, -->
<!--            models$w_adj_0_to_60, -->
<!--            models$unw_unadj_1_to_60, -->
<!--            models$w_adj_1_to_60, -->
<!--            models$unw_unadj_15_to_180, -->
<!--            models$w_adj_15_to_180, -->
<!--            model.names = c("RSV 0-60d: Unweighted, unadjusted", -->
<!--                            "RSV 0-60d: Weighted, adjusted", -->
<!--                            "RSV 1-60d: Unweighted, unadjusted", -->
<!--                            "RSV 1-60d: Weighted, adjusted", -->
<!--                            "RSV 15-180d: Unweighted, unadjusted", -->
<!--                            "RSV 15-180d: Weighted, adjusted"), -->
<!--                            # "Weighted, adjusted for CE week"),  -->
<!--            exp = TRUE) -->


<!-- export_summs(models$unw_unadj_0_to_60, -->
<!--            models$w_adj_0_to_60, -->
<!--            models$unw_unadj_1_to_60, -->
<!--            models$w_adj_1_to_60, -->
<!--            models$unw_unadj_15_to_180, -->
<!--            models$w_adj_15_to_180, -->
<!--            model.names = c("RSV 0-60d: Unweighted, unadjusted", -->
<!--                            "RSV 0-60d: Weighted, adjusted", -->
<!--                            "RSV 1-60d: Unweighted, unadjusted", -->
<!--                            "RSV 1-60d: Weighted, adjusted", -->
<!--                            "RSV 15-180d: Unweighted, unadjusted", -->
<!--                            "RSV 15-180d: Weighted, adjusted"), -->
<!--                            # "Weighted, adjusted for CE week"),  -->
<!--            exp = TRUE) -->

<!-- ``` -->



<!-- ```{r echo = FALSE, output = FALSE, message = FALSE , warning = FALSE} -->

<!-- # outcome = "outcome_rsv_postacute_30" -->
<!-- #  -->
<!-- # dataset_iptw_not_hospitalized = dataset_with_iptw %>%  -->
<!-- #   mutate(outcome_rsv_60_days = ifelse(days_from_index_to_rsv <= 60 & days_from_index_to_rsv >=0 , 1, 0)) %>%  -->
<!-- #   mutate(outcome_rsv_60_days = ifelse(is.na(outcome_rsv_60_days), 0, outcome_rsv_60_days)) %>%  -->
<!-- #   filter(hospitalized_at_index == "Not hospitalized") -->
<!-- #  -->
<!-- # outcome = "outcome_rsv_60_days" -->
<!-- #  -->
<!-- # models = list() -->
<!-- #  -->
<!-- # models$model_unweighted_unadjusted <- run_logistic_regression(df = dataset_iptw_not_hospitalized, -->
<!-- #                                                        model_formula = paste0(outcome, " ~ covid"), -->
<!-- #                                                        weight_method = "none") -->
<!-- #  -->
<!-- # models$model_unweighted_adjusted <- run_logistic_regression(df = dataset_iptw_not_hospitalized, -->
<!-- #                                                          model_formula = paste0(outcome, -->
<!-- #                                                                                 " ~ covid + sex_cat + util_ed + util_inpatient + util_outpatient + util_other"), -->
<!-- #                                                          weight_method = "none") -->
<!-- #  -->
<!-- # models$model_weighted_unadjusted <- run_logistic_regression(df = dataset_iptw_not_hospitalized, -->
<!-- #                                                        model_formula = paste0(outcome, " ~ covid"), -->
<!-- #                                                        weight_method = "lr") -->
<!-- #  -->
<!-- # models$model_weighted_adjusted <- run_logistic_regression(df = dataset_iptw_not_hospitalized, -->
<!-- #                                                          model_formula = paste0(outcome, -->
<!-- #                                                                                 " ~ covid + sex_cat + util_ed + util_inpatient + util_outpatient + util_other"), -->
<!-- #                                                          weight_method = "lr") -->

<!-- ``` -->

<!-- ```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width=12, fig.height=6} -->

<!-- # plot_summs(models$model_unweighted_unadjusted, -->
<!-- #            models$model_unweighted_adjusted, -->
<!-- #            models$model_weighted_unadjusted, -->
<!-- #            models$model_weighted_adjusted, -->
<!-- #            model.names = c("Unweighted, unadjusted", -->
<!-- #                            "Unweighted, adjusted", -->
<!-- #                            "Weighted (LR), unadjusted", -->
<!-- #                            "Weighted (LR), adjusted" -->
<!-- #                            ),  -->
<!-- #            exp = TRUE) -->

<!-- ``` -->

<!-- ## Time to outcome analyis -->

<!-- ### Time to RSV distribution -->

<!-- ```{r message = FALSE, warning = FALSE, echo = FALSE, fig.width = 6, fig.height =4} -->

<!-- outcome = "outcome_rsv_same_day" -->
<!-- comparison_group = comparison_group_string -->

<!-- # iptw_flu <- analytic_dataset_final %>% -->
<!-- #   do_iptw(cohort_entry_start_date = cohort_entry_start_date, -->
<!-- #           comparison_cohort = comparison_group, -->
<!-- #           weight_formula = "covid~age_group+sex_cat+race_eth_cat+ce_week_factor", -->
<!-- #           iptw_description = paste0("covid_", comparison_group, "_", outcome)) -->

<!-- dataset_with_iptw <- results_tbl( paste0(paste0("covid_", comparison_group, "_", outcome),'_tabc')) %>%  -->
<!--   collect() -->

<!-- dataset_with_iptw %>%  -->
<!--   filter(!is.na(days_from_index)  ) %>%  -->
<!--   ggplot() + -->
<!--   geom_vline(xintercept = 180) + -->
<!--   geom_vline(xintercept = 30) + -->
<!--   geom_vline(xintercept = 15) + -->
<!--     # geom_histogram(aes(x=days_from_index, fill = sub_cohort), -->
<!--     #                bins = 60) + -->
<!--     #        # stat = "density",width = 1) + -->
<!--   geom_bar(aes(x=days_from_index, fill = sub_cohort, alpha=0.3), -->
<!--            stat = "density", -->
<!--            trim = TRUE, -->
<!--            alpha = 0.3, -->
<!--            position = "dodge", width = 1) + -->
<!--   # scale_y_continuous(limits=c(0,1)) + -->
<!--   # geom_histogram(aes(x=days_from_index, fill = sub_cohort), -->
<!--   #                bins = 50) + -->
<!--   facet_wrap(~rsv_occurrence_period, ncol=1, scales = "free_y") + -->
<!--   theme_bw() +  -->
<!--   scale_fill_manual(values = wes_palette("FantasticFox1", n=3, type = "continuous")) + -->
<!--   scale_color_manual(values = wes_palette("FantasticFox1", n=3, type = "continuous")) + -->
<!--   labs(x="Days from index date to RSV date for patients with presence of RSV") + -->
<!--   theme(legend.position = "top") + -->
<!--   ggtitle("Days from index to RSV outcome") -->


<!-- dataset_with_iptw %>%  -->
<!--   filter(!is.na(days_from_index)  ) %>%  -->
<!--   ggplot() + -->
<!--   geom_vline(xintercept = 180) + -->
<!--   geom_vline(xintercept = 30) + -->
<!--   geom_vline(xintercept = 15) + -->
<!--     # geom_histogram(aes(x=days_from_index, fill = sub_cohort), -->
<!--     #                bins = 60) + -->
<!--     #        # stat = "density",width = 1) + -->
<!--   geom_bar(aes(x=days_from_index, fill = sub_cohort, alpha=0.3), -->
<!--            stat = "density", -->
<!--            trim = TRUE, -->
<!--            alpha = 0.3, -->
<!--            position = "dodge", width = 1) + -->
<!--   # scale_y_continuous(limits=c(0,1)) + -->
<!--   # geom_histogram(aes(x=days_from_index, fill = sub_cohort), -->
<!--   #                bins = 50) + -->
<!--   # facet_wrap(~rsv_occurrence_period, ncol=1, scales = "free_y") + -->
<!--   theme_bw() +  -->
<!--   scale_fill_manual(values = wes_palette("FantasticFox1", n=3, type = "continuous")) + -->
<!--   scale_color_manual(values = wes_palette("FantasticFox1", n=3, type = "continuous")) + -->
<!--   labs(x="Days from index date to RSV date for patients with presence of RSV") + -->
<!--   theme(legend.position = "top") + -->
<!--   ggtitle("Days from index to RSV outcome") -->

<!-- ``` -->

<!-- ### Survival curves -->

<!-- Notice that if the  survival curves cross here (like for covid and flu) so we cannot use Cox modeling, unless we stratify or address the outcome such that these curves do not cross.  -->

<!-- ```{r echo=FALSE, message = FALSE, warning = FALSE} -->

<!-- cohort_fu <- -->
<!--   dataset_with_iptw %>% -->
<!--   rowwise() %>% -->
<!--   mutate(fu_date = case_when( -->
<!--     is.na(rsv_evidence_date) ~ as.Date(ce_date + days(180)), -->
<!--     days_from_index_to_rsv >= 180 ~ as.Date(ce_date + days(180)), -->
<!--     TRUE ~ rsv_evidence_date -->
<!--   )) %>%  -->
<!--   mutate(rsv_outcome = ifelse(days_from_index_to_rsv >= 0 & days_from_index_to_rsv < 180, 1, 0)) %>%  -->
<!--   mutate(rsv_outcome = ifelse(is.na(rsv_outcome), 0, rsv_outcome)) %>%  -->
<!--   mutate( -->
<!--     index_date = as.Date(ce_date, "%Y-%m-%d"), -->
<!--     fu_time_mo = trunc(as.numeric(as.Date(fu_date, "%Y-%m-%d") - index_date) / 30), -->
<!--     fu_time_day = as.numeric(as.Date(fu_date, "%Y-%m-%d") - index_date), # follow-up time in days -->
<!--     fu_time_week = as.numeric(floor_date(fu_date, unit="week") - floor_date(ce_date, unit="week")) , -->
<!--     exposure_status = as.factor(covid) -->
<!--   )  -->

<!-- ### Implement secondary exclusion criteria -->
<!-- fu_patients <- cohort_fu %>% -->
<!--   filter(fu_time_day > 0)# need to chnge this, should change to follow up being 180 days if no cases (or 300) -->

<!-- fu_patients$female <- case_when( -->
<!--   fu_patients$sex_cat == "Female" ~ 1, -->
<!--   TRUE ~ 0 -->
<!-- ) -->

<!-- fu_patients_detailed <- separate(fu_patients,  -->
<!--                                  index_date,  -->
<!--                                  c("index_year", "index_month.v2", "index_day"), sep = "-") -->
<!-- #  -->
<!-- fu_patients_detailed$index_month.v2 <- as.numeric(fu_patients_detailed$index_month.v2) ## -->
<!-- # # table(pedsnet_index$index_year) -->
<!-- fu_patients_detailed$index_month.seq <- ifelse(fu_patients_detailed$index_year == 2020,  -->
<!--                                         fu_patients_detailed$index_month.v2,  -->
<!--                                         fu_patients_detailed$index_month.v2 + 12) -->
<!-- # # summary(pedsnet_index$index_month.seq) -->
<!-- #  -->
<!-- #  -->
<!-- # ### Subset data to complete observations -->
<!-- fu_patients_detailed$age_baseline <- fu_patients_detailed$age_years_on_ce_date -->


<!-- fu_patients_subcols <- fu_patients_detailed[, c("exposure_status", "age_baseline", "age_group", "female", "race_eth_cat", -->
<!--                                            "index_month.seq")] -->
<!-- fu_complete <- fu_patients_detailed[complete.cases(fu_patients_subcols), ] -->
<!-- fu_complete <- fu_complete %>% as.data.frame() -->


<!-- fit_scurve_u <- survfit(Surv(fu_time_week, rsv_outcome) ~ exposure_status, data = fu_complete) -->

<!-- # Fit weighted survival curve -->
<!-- fit_scurve_w <- survfit(Surv(fu_time_week, rsv_outcome) ~ exposure_status, weights = capped_iptw , data = fu_complete) -->

<!-- fit_scurve_finegrain <- survfit(Surv(fu_time_day, rsv_outcome) ~ exposure_status, weights = capped_iptw , data = fu_complete) -->

<!-- plot(fit_scurve_u, col = 1:2, ylim = c(0.95, 1.0), xlab = "Week", ylab = "Pr(no RSV), unweighted") -->
<!-- legend(1, 0.96, c("Comparison group", "SARS-CoV-2"), col = 1:2, lwd = 1, bty = "n") -->

<!-- # Plot weighted survival curve (Figure 8) -->
<!-- cat("\n\n# Figure 8. Weighted survival curve\n\n") -->
<!-- plot(fit_scurve_w, col = 1:2, ylim = c(0.95, 1.0), xlab = "Week", ylab = "Pr(no RSV), weighted") -->
<!-- legend(1, 0.96, c("No SARS-CoV-2", "SARS-CoV-2"), col = 1:2, lwd = 1, bty = "n") -->


<!-- library("survival") -->
<!-- library("survminer") -->


<!-- surv_plot_finegrain <- ggsurvplot(fit_scurve_finegrain, xlab = "Time (days)", conf.int = TRUE, -->
<!--            pval = TRUE) # Figure 9 -->


<!-- surv_plot_finegrain$plot <- surv_plot_finegrain$plot + ylim(c(.95, 1))  -->

<!-- surv_plot_finegrain -->

<!-- ``` -->

<!-- ### Same-Day patients -->

<!-- Would be great to understand the entire trajectories around these patients, -7 to 7 days of their double covid/rsv diagnosis or test. And also, to support this with literature on co-infections during the surge.  -->

<!-- In short though, the flipped effect between our results and the other paper comes down to the entire statistical power in the same-day patients. So we really need to decide what to do there / figure that out. -->

<!-- ```{r echo = FALSE, message = FALSE, warning = FALSE} -->

<!-- same_day_baes <- dataset_with_iptw %>% filter(days_from_index_to_rsv == 0)  -->

<!-- table1(~lab_confirmed_rsv_outcome | sub_cohort*lab_confirmed_index, data = same_day_baes, overall = F) -->

<!-- table1(~lab_confirmed_rsv_outcome | sub_cohort, data = same_day_baes, overall = F) -->

<!-- ## Distribution of WHEN the day 0 patients are -->

<!-- dataset_with_iptw %>%  -->
<!--   mutate(same_day_rsv = ifelse(days_from_index_to_rsv==0, 1, 0)) %>%  -->
<!--   mutate(same_day_rsv = ifelse(is.na(days_from_index_to_rsv), 0, same_day_rsv)) %>%  -->
<!--   group_by(sub_cohort, same_day_rsv, ce_week_days_numeric) %>%  -->
<!--   summarise(n=n_distinct(person_id)) %>%  -->
<!--   ungroup() %>%  -->
<!--   group_by(sub_cohort, ce_week_days_numeric) %>%  -->
<!--   mutate(total = sum(n)) %>%  -->
<!--   ungroup() %>%  -->
<!--   collect() %>%  -->
<!--   mutate(prop_with_rsv_day_0 = n/total) %>%  -->
<!--   complete(sub_cohort, same_day_rsv, ce_week_days_numeric) %>%  -->
<!--   ungroup() %>%  -->
<!--   mutate(prop_with_rsv_day_0 = ifelse(is.na(prop_with_rsv_day_0), 0, prop_with_rsv_day_0)) %>%  -->
<!--   filter(same_day_rsv == 1) %>%  -->
<!--   ggplot() + -->
<!--   geom_bar(aes(x=ce_week_days_numeric, y=prop_with_rsv_day_0, fill = sub_cohort), stat="identity", position="dodge") -->


<!-- dataset_with_iptw %>%  -->
<!--   mutate(same_day_rsv = ifelse(days_from_index_to_rsv==0, 1, 0)) %>%  -->
<!--   filter(!is.na(same_day_rsv)) %>%  -->
<!--   # mutate(same_day_rsv = ifelse(is.na(days_from_index_to_rsv), 0, same_day_rsv)) %>%  -->
<!--   group_by(sub_cohort, same_day_rsv, ce_week_days_numeric) %>%  -->
<!--   summarise(n=n_distinct(person_id)) %>%  -->
<!--   ungroup() %>%  -->
<!--   group_by(sub_cohort, ce_week_days_numeric) %>%  -->
<!--   mutate(total = sum(n)) %>%  -->
<!--   ungroup() %>%  -->
<!--   collect() %>%  -->
<!--   mutate(prop_with_rsv_day_0 = n/total) %>%  -->
<!--   complete(sub_cohort, same_day_rsv, ce_week_days_numeric) %>%  -->
<!--   ungroup() %>%  -->
<!--   mutate(prop_with_rsv_day_0 = ifelse(is.na(prop_with_rsv_day_0), 0, prop_with_rsv_day_0)) %>%  -->
<!--   filter(same_day_rsv == 1) %>%  -->
<!--   ggplot() + -->
<!--   geom_bar(aes(x=ce_week_days_numeric, y=prop_with_rsv_day_0, fill = sub_cohort), stat="identity", position="dodge") -->

<!-- ``` -->


<!-- Additional metrics for the abstract: -->

<!-- ```{r} -->
<!-- analytic_dataset_final %>%  -->
<!--   group_by(outcome_rsv_0_to_60, outcome_rsv_same_day, sub_cohort) %>%  -->
<!--   summarise(n = n_distinct(person_id)) %>%  -->
<!--   ungroup() %>%  -->
<!--   group_by(sub_cohort) %>%  -->
<!--   mutate(total = sum(n)) %>%  -->
<!--   mutate(p = n/total) %>%  -->
<!--   mutate(pct = paste0(as.character(round(p*100, 2)), " %")) %>%  -->
<!--   prettify_kable() -->

<!-- analytic_dataset_final %>%  -->
<!--   group_by(outcome_rsv_0_to_60, sub_cohort) %>%  -->
<!--   summarise(n = n_distinct(person_id)) %>%  -->
<!--   ungroup() %>%  -->
<!--   group_by(sub_cohort) %>%  -->
<!--   mutate(total = sum(n)) %>%  -->
<!--   mutate(p = n/total) %>%  -->
<!--   mutate(pct = paste0(as.character(round(p*100, 2)), " %")) %>%  -->
<!--   prettify_kable() -->

<!-- ``` -->



<!-- <!-- ### Hazard ratios --> -->





