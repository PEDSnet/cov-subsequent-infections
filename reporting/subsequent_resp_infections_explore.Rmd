---
title: "Subsequent Infections - RSV Study Analysis - Subsequent respiratory infection Exploration"
date: "`r format(Sys.time(), '%m-%d-%y')`"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_collapsed: yes
    toc_float: yes
---

Exploratory report to summarise the landscape of respiratory infections following acute (index) COVID or Influenza infection.

```{r include=FALSE}
# Default taken from R notebook behavior: when knitting, wd will always be location of notebook
base_dir <- '..'
Sys.setenv(PEDSNET_SKIP_REQUEST_EXECUTION=1)
try(source('../site/run.R')) # May not be able to make db connection
try(source('site/run.R'))

# Set to "local" to read data from ../results, or another value to read from db
data_source <- if_else(config('execution_mode') == 'distribution', 'local', 'not_local')

require(tibble)
require(knitr)
require(kableExtra)
require(readr)
require(table1)
require(ggplot2)
library(GGally)
require(tidyverse)
require(lubridate)
library(wesanderson)
library(survey)
library(survival)
library(WeightIt)
library(cobalt)
library(jtools)
require(cobalt)
require(WeightIt)
require(scattermore)
require(broom)
require(tableone)

get_results <- function(tbl_name) {
  if (data_source == 'local') {
    rslt <- read_csv(paste0('../results/', tbl_name, '.csv'))
  }
  else {
    rslt <- results_tbl(tbl_name) %>% collect()
  }
  rslt
}


prettify_kable <- function(data, indents = list()) {
  
  if (length(indents)==0) {
      data %>% 
        kbl(digits = 2, format.args = list(big.mark = ',')) %>%
        kable_classic(full_width = F, html_font = "Arial") %>% 
        kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>% 
        column_spec(1, bold = F, border_right = T)
  } else {
      data %>% 
        kbl(digits = 2, format.args = list(big.mark = ',')) %>%
        kable_classic(full_width = F, html_font = "Arial") %>% 
        kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>% 
        add_indent(indents) %>% 
        column_spec(1, bold = F, border_right = T)
  }

  # 
  # data %>% 
  #   kable(digits = 2, format.args = list(big.mark = ',')) %>% 
  #   kable_styling(bootstrap_options = c("striped", "hover")) %>% 
  #   column_spec(1, bold = T, border_right = T)
}

my.render.cont <- function(x) {
  with(stats.apply.rounding(stats.default(x), digits = 6), c("",
    "Mean (SD)" = sprintf("%0.1f (%0.1f)", as.numeric(MEAN), as.numeric(SD)),
    "Median [Q1-Q3]" = sprintf("%0.1f [%0.1f - %0.1f]", as.numeric(MEDIAN), as.numeric(Q1), as.numeric(Q3))
  ))
}

my.render.cat <- function(x) {
  c("", sapply(stats.default(x), function(y) {
    with(
      y,
      sprintf("%s (%0.1f%%)", format(FREQ, big.mark = ","), PCT)
    )
  }))
}

pvalue <- function(x, ...) {
  # Construct vectors of data y, and groups (strata) g
  # from https://cran.r-project.org/web/packages/table1/vignettes/table1-examples.html#example-a-column-of-p-values

  y <- unlist(x)
  g <- factor(rep(1:length(x), times = sapply(x, length)))
  if (is.numeric(y)) {
    # For numeric variables, perform a standard 2-sample t-test
    p <- t.test(y ~ g)$p.value
  } else {
    # For categorical variables, perform a chi-squared test of independence
    p <- chisq.test(table(y, g))$p.value
  }
  # Format the p-value, using an HTML entity for the less-than sign.
  # The initial empty string places the output on the line below the variable label.
  c("", sub("<", "&lt;", format.pval(p, digits = 3, eps = 0.001)))
}

# fron https://rdrr.io/github/junkka/ehahelper/src/R/broom_coxme.R
tidy.coxme <- function(x, exponentiate = FALSE, conf.int = 0.95, ...) {
  beta <- x$coefficients
  nvar <- length(beta)
  nfrail <- nrow(x$var) - nvar
  nn <- c("estimate", "exp()", "std.error", "statistic", "p.value")
  se <- sqrt(diag(as.matrix(x$var))[nfrail + 1:nvar])
  z <- qnorm((1 + conf.int) / 2, 0, 1)
  ret <- data.frame(
    "term" = names(beta),
    "estimate" = beta,
    "std.error" = se,
    "statistic" = beta / se,
    "p.value" = 1 - pchisq((beta / se)^2, 1),
    "conf.low" = beta - z * se,
    "conf.high" = beta + z * se,
    "beta" = beta
  )
  if (exponentiate) {
    ret$estimate <- exp(ret$estimate)
    ret$conf.low <- exp(ret$conf.low)
    ret$conf.high <- exp(ret$conf.high)
  }
  rownames(ret) <- c(1:nrow(ret))
  ret
}

postacute_min_start_date = as.Date("2022-04-01")
postacute_max_end_date = as.Date("2023-01-01")

cohort_entry_start_date = as.Date("2022-03-01")
cohort_entry_end_date = as.Date("2022-07-01")

cohort_1_label = "rsv_study_cohort"


description = "covid_flu_3"
description = "covid_flu_noutil"
description = "covid_flu_util"
# description = "covid_ari_util"
# description = "covid_ari_ce_week"
description = "covid_flu_nonexclude"

description = "covid_flu_comparison"
description = "covid_ari_comparison"
comparison_group_string = "Respiratory"

cohort_1_label = "rsv_study_cohort"

analytic_dataset <-
  results_tbl(paste0(cohort_1_label, "_analytic_dataset")) %>% 
  filter(ce_date >= cohort_entry_start_date,
         ce_date < cohort_entry_end_date)

analytic_dataset_final <-
  analytic_dataset %>% 
  filter(sex_cat != "Other/unknown") %>% 
  filter(is.na(covid_index_date_imputed) | covid_index_date_imputed==0) %>% 
  group_by(person_id) %>% 
  mutate(exclude = max(exclude_for_prior_rsv)) %>% 
  filter(exclude < 1) %>%
  slice_min(rsv_evidence_date, with_ties=FALSE) %>% 
  ungroup() %>% 
  mutate(lab_confirmed_index = ifelse(lab_confirmed==1, "lab confirmed", "dx only")) %>% 
  mutate(lab_confirmed_rsv_outcome = ifelse(lab_confirmed_rsv==1, "lab confirmed RSV", "dx only")) %>% 
  # mutate(visit_span_criteria_rank = as.character(visit_span_criteria_rank)) %>% 
  mutate(hospitalized_at_index = ifelse(hospital_flag==1 & visit_span_criteria_rank=="1", "Hospitalized", "Not hospitalized")) %>% 
  mutate(hospital_flag = as.character(hospital_flag)) %>% 
  mutate(hosp_with_vent = as.character(hosp_with_vent)) %>% 
  mutate(hospitalized_at_index = ifelse(is.na(hospitalized_at_index), "Not hospitalized", hospitalized_at_index)) %>% 
  mutate(hosp_with_vent = ifelse(is.na(hosp_with_vent), "0", hosp_with_vent))  %>% 
  mutate(hospitalized_at_index_detail = ifelse(hospitalized_at_index=="Hospitalized" & hosp_with_vent=="1", "Hospitalized with ventilation", hospitalized_at_index)) %>% 
  # mutate(rsv_outcome_postacute = ifelse(rsv_occurrence_period == "post acute (15-180 days after index)", 1, 0)) %>% 
  collect()

visit_counts <- results_tbl(paste0(cohort_1_label, "_visit_lookback_counts")) %>% 
  collect()

respiratory_outcomes <- results_tbl(paste0(cohort_1_label, "_respiratory_outcomes")) %>% 
    inner_join(cdm_tbl("visit_occurrence") %>% select(visit_occurrence_id, visit_concept_name), by="visit_occurrence_id") %>% compute_new()


resp_meta <- respiratory_outcomes %>% collect() %>% 
  select(person_id, concept_name, condition_start_date, rsv_related, influenza_related, visit_occurrence_id, visit_concept_name) %>% 
  filter(is.na(influenza_related), is.na(rsv_related)) %>% 
  inner_join(analytic_dataset_final %>% select(person_id, ce_date, sub_cohort), by="person_id") %>% 
  filter(condition_start_date < ce_date + days(180)) %>%
  filter(condition_start_date >= ce_date + days(1)) %>% 
  group_by(person_id, concept_name, condition_start_date) %>% 
  filter(row_number()==1) %>% 
  ungroup() %>% 
  group_by(person_id) %>% 
  mutate(earliest_resp_outcome = min(condition_start_date)) %>% 
  mutate(resp_dx_within_30_days = ifelse(as.numeric(earliest_resp_outcome - ce_date) < 30,
                                           1, 0)) %>% 
  ungroup() %>% 
  mutate(days_til_resp = as.numeric(condition_start_date-ce_date)) %>% 
  mutate(visit_type = case_when(visit_concept_name %in% c("Emergency Department Admit to Inpatient Hospital Stay- PCORNET", 
                                                          "Inpatient Visit",
                                                          "Observation Stay - PCORNET") ~ "Inpatient",
                                visit_concept_name %in% c("Emergency Room Visit", 
                                                          "Outpatient Visit", 
                                                          "Other ambulatory visit",
                                                          "Outpatient Visit - Non Physician"
                                                          ) ~ "Outpatient",
                                TRUE ~ "Other"))

n = 6
m = 4


```

# Top codes occurring at least 1 day after index infection, by cohort

First, we look at a table of the respiratory concept codes that occur the most frequently, within the cohort, between 1 to 180 days after the index date. In this case, the index date was the evidence of the first COVID or Influenza, in each cohort respectively, and we are interested in identifying subsequent respiratory infections shortly following the index infections.

However, we're facing some difficulty ascertaining what a "subsequent" infection is versus an accompanying diagnosis concurrent with the index COVID/Flu, and so this report is an attempt to help us figure out what criteria we should use to determine subsequent infections.


```{r echo=FALSE, message = FALSE, warning=FALSE, fig.width = n, fig.height=m}
top_covid_dxs <- resp_meta %>% 
  group_by(concept_name, sub_cohort) %>% 
  summarise(n_pats = n_distinct(person_id)) %>% 
  filter(sub_cohort == "COVID") %>% 
  arrange(desc(n_pats)) %>% 
  head(15) %>% 
  collect() 

top_covid_dxs %>% 
  prettify_kable()

top_flu_dxs <- resp_meta %>% 
  group_by(concept_name, sub_cohort) %>% 
  summarise(n_pats = n_distinct(person_id)) %>% 
  filter(sub_cohort == "Influenza") %>% 
  arrange(desc(n_pats)) %>% 
  head(15) 

top_flu_dxs %>% 
  prettify_kable()

```

For each of the top codes, look at the distribution of time til it comes on:

Each of these plots shows, for one of the top 15 codes, a histrogram of days from index date til the code is used, for the two different cohorts.

We should be able to use this information to identify a threshold or other criteria from which to determine what a "subsequent" infection is, versus a diagnosis code that is actually a relic of continuation of care for one of the index COVID or Flu cases. 

```{r echo=FALSE, message = FALSE, warning=FALSE, fig.width =12, fig.height=8}

resp_meta %>% collect() %>% 
  inner_join(top_covid_dxs %>% select(concept_name, n_pats), by="concept_name") %>% 
  filter(sub_cohort == "COVID") %>% 
  mutate(top_concept = paste0("N: ", n_pats, "\n", concept_name)) %>% 
  ggplot() +
  geom_histogram(aes(x=days_til_resp, fill = visit_type),position="stack", alpha=0.5) +
  facet_wrap(~top_concept, scales="free") +
  theme_bw() +
  scale_fill_brewer(palette = "Dark2")

resp_meta %>% collect() %>% 
  inner_join(top_flu_dxs %>% select(concept_name, n_pats), by="concept_name") %>% 
  filter(sub_cohort == "Influenza") %>% 
  mutate(top_concept = paste0("N: ", n_pats, "\n", concept_name)) %>% 
  ggplot() +
  geom_histogram(aes(x=days_til_resp, fill = visit_type),position="stack", alpha=0.5) +
  facet_wrap(~top_concept, scales="free") +
  theme_bw() +
  scale_fill_brewer(palette = "Dark2")

```


```{r echo=FALSE, message = FALSE, warning=FALSE, fig.width = n, fig.height=m}


```


```{r echo=FALSE, message = FALSE, warning=FALSE, fig.width = n, fig.height=m}


```


```{r echo=FALSE, message = FALSE, warning=FALSE, fig.width = n, fig.height=m}


```









