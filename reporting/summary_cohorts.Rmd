---
title: "Subsequent Infections - Pre-matched Cohort Analysis"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_collapsed: yes
    toc_float: yes
---

TODO: in here, combine the old precohort_eda and cohorts_pre_matching work to make a document that can be an artifact of what
went into cohort creation. Can be referenced later with attrition tables, table 1s, etc., and visuals of the temporal counts of the disease

Can also use it to help pick time periods to focus on based on data availibility

This report provides a summary of available data on prospective cohorts created for the following analysis timeframes. Attrition tables are attached to show available data vs. usable data, along with a Table 1 for each cohort of study variables to the extent to which they are available at this stage of the study.

```{r include=FALSE}
# Default taken from R notebook behavior: when knitting, wd will always be location of notebook
base_dir <- '..'
Sys.setenv(PEDSNET_SKIP_REQUEST_EXECUTION=1)
try(source('../site/run.R')) # May not be able to make db connection

# Set to "local" to read data from ../results, or another value to read from db
data_source <- if_else(config('execution_mode') == 'distribution', 'local', 'not_local')

require(tibble)
require(knitr)
require(kableExtra)
require(readr)
require(table1)
require(ggplot2)
require(tidyverse)
require(lubridate)

get_results <- function(tbl_name) {
  if (data_source == 'local') {
    rslt <- read_csv(paste0('../results/', tbl_name, '.csv'))
  }
  else {
    rslt <- results_tbl(tbl_name) %>% collect()
  }
  rslt
}


prettify_kable <- function(data) {
  data %>% kable(digits = 2, format.args = list(big.mark = ',')) %>% 
    kable_styling(bootstrap_options = c("striped", "hover")) %>% 
    column_spec(1, bold = T, border_right = T)
}


```

# Cohort availability

## Data timeframe

Data shown available from April 1, 2021 to October 1, 2023. Cohort entry periods and outcome periods may be fine tuned for final analysis.

### Attrition

Attrition table of patients that fit each cohort definition, and whether they are eligible for the study or not. 

Eligibility requirements were:
1. Less than 5 years of age at the cohort entry date
2. Fits one of the cohort entrance criteria (flu, covid, or none)
3. Has a visit in the 1-6 months following cohort entry date
4. Has had a prior visit within 1.5 years of the cohort entry date

These criteria are broken down further in the following tables.

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

cohort_1_label = "_06210223_"
cohort_1_label = "_04211023_"

cohort_prematch <- results_tbl(paste0("ce", cohort_1_label, "unfiltered"))

table1(~ study_eligible | cohort_assignment, 
       data= cohort_prematch %>% mutate(study_eligible = as.character(study_eligible)))

table1(~ cohort_assignment | study_eligible, 
       data= cohort_prematch %>% mutate(study_eligible = as.character(study_eligible)))

```

Table of eligibility requirement breakdown and attrition:

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
ce_start_date = as.Date("2021-04-01")
ce_end_date = as.Date("2023-10-01")

cohort_prematch <- results_tbl(paste0("ce", cohort_1_label, "unfiltered")) %>% 
  mutate(satisfied_prior_visit_criteria = visit_within_n_years > 0,
         cohort_entry_date_in_window = ce_date >= ce_start_date &
        ce_date < ce_end_date) %>% 
  mutate(study_eligible = as.character(study_eligible),
         age_at_ce_under_limit = as.character(age_at_ce_under_limit),
         has_visit_in_followup_period = ifelse(has_visit_in_followup_period==1, TRUE, FALSE))
## Want this table to be: percent of each cohort with a pre visit, post visit, etc. 
table1(~ study_eligible + 
         age_at_ce_under_limit +
         satisfied_prior_visit_criteria + 
         has_visit_in_followup_period + 
         cohort_entry_date_in_window +
         has_visit_in_followup_period*satisfied_prior_visit_criteria | cohort_assignment, 
       data= cohort_prematch)

```

Distribution of cohort entry dates, broken down by cohort group. Study eligible patients only. 

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=10, fig.height=6}

cohort_prematch <- results_tbl(paste0("ce", cohort_1_label, "unfiltered"))

cohort_prematch %>% 
  filter(study_eligible ==1) %>% 
  ggplot() +
  geom_density(aes(x=ce_date, fill=cohort_assignment, alpha=0.2, color=cohort_assignment), position="stack") +
  theme_bw() +
  scale_fill_brewer(palette="Dark2") +
  scale_color_brewer(palette = "Dark2") +
  geom_vline(xintercept=as.Date("2021-12-01") ) +
  geom_vline(xintercept=as.Date("2023-03-01")  )


cohort_prematch %>% 
  filter(study_eligible ==1) %>% 
  ggplot() +
  geom_density(aes(x=ce_date, alpha=0.2, color=cohort_assignment), position="dodge") +
  theme_bw() +
  # scale_fill_brewer(palette="Dark2") +
  scale_color_brewer(palette = "Dark2") +
  geom_vline(xintercept=as.Date("2021-12-01") ) +
  geom_vline(xintercept=as.Date("2023-03-01")  )

```

### Table 1 of study eligible patients

To help with understanding what we will obtain after matching, the following is a Table 1 of demographic and study-related matching criteria variables. The cohort in the following table is limited to patients satisfying the study eligbility criteria (shown above), and only patients with covid, influenza, or no infection are shown (the other overlapping cohort patients have been removed). This table describes age, sex, race/ethnicity, and medical complexity. Cohort entry week distributions are shown in a figure below.

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
cohort_prematch_demo <- results_tbl(paste0("ce", cohort_1_label, "unfiltered_demo")) %>% 
  filter(cohort_assignment %in% c("Covid", "Influenza", "No infection")) %>% 
  filter(study_eligible==1) %>% 
  mutate(complex_chronic_flag = mock_medical_complexity)

table1(~ sex_cat + race_eth_cat + age_cat_at_ce + complex_chronic_flag + visit_type_inpatient_or_ed +
         visit_type_outpatient + visit_type_admin_other_telemed | cohort_assignment,
       data = cohort_prematch_demo)
```

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=12, fig.height=4}
cohort_prematch_demo <- results_tbl(paste0("ce", cohort_1_label, "unfiltered_demo")) %>% 
  filter(cohort_assignment %in% c("Covid", "Influenza", "No infection")) %>% 
  filter(study_eligible==1) %>% 
  mutate(complex_chronic_flag = mock_medical_complexity)

cohort_prematch_demo %>% 
  group_by(cohort_entry_week, cohort_assignment) %>% 
  mutate(cohort_entry_week = as.Date(cohort_entry_week)) %>% 
  summarise(n_pats=n()) %>% 
  ungroup() %>% 
  group_by(cohort_assignment) %>% 
  mutate(total_cohort = sum(n_pats)) %>% 
  mutate(prop_pats = as.numeric(n_pats)/as.numeric(total_cohort)) %>% 
  ggplot() +
  geom_bar(aes(x=cohort_entry_week, y = prop_pats, fill=cohort_assignment, alpha=0.5), stat="identity", position="dodge") +
  theme_bw() +
  scale_fill_brewer(palette = "Dark2") +
  labs(x="Cohort entry week", y="Proportion of patients in cohort group") +
  geom_vline(xintercept=as.Date("2021-12-01") ) +
  geom_vline(xintercept=as.Date("2023-03-01")  )

cohort_prematch_demo %>% 
  group_by(cohort_entry_week, cohort_assignment) %>% 
  mutate(cohort_entry_week = as.Date(cohort_entry_week)) %>% 
  summarise(n_pats=n()) %>% 
  ungroup() %>% 
  group_by(cohort_assignment) %>% 
  mutate(total_cohort = sum(n_pats)) %>% 
  mutate(prop_pats = as.numeric(n_pats)/as.numeric(total_cohort)) %>% 
  ggplot() +
  geom_bar(aes(x=cohort_entry_week, y = n_pats, fill=cohort_assignment, alpha=0.5), stat="identity", position="dodge") +
  theme_bw() +
  scale_fill_brewer(palette = "Dark2") +
  labs(x="Cohort entry week", y="Number of patients in cohort group") +
  geom_vline(xintercept=as.Date("2021-12-01") ) +
  geom_vline(xintercept=as.Date("2023-03-01")  )

```

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=12, fig.height=8}
cohort_prematch_demo %>% 
  group_by(cohort_entry_week, cohort_assignment, age_cat_at_ce) %>% 
  mutate(cohort_entry_week = as.Date(cohort_entry_week)) %>% 
  summarise(n_pats=n()) %>% 
  ungroup() %>% 
  group_by(cohort_assignment) %>% 
  mutate(total_cohort = sum(n_pats)) %>% 
  mutate(prop_pats = as.numeric(n_pats)/as.numeric(total_cohort)) %>% 
  ggplot() +
  geom_bar(aes(x=cohort_entry_week, y = prop_pats, fill=cohort_assignment, alpha=0.5), stat="identity", position="dodge") +
  theme_bw() +
  scale_fill_brewer(palette = "Dark2") +
  labs(x="Cohort entry week", y="Proportion of patients in cohort group") +
  facet_wrap(~age_cat_at_ce, ncol=2, scales = "free") +
  geom_vline(xintercept=as.Date("2021-12-01") ) +
  geom_vline(xintercept=as.Date("2023-03-01")  )
  
```

Comparative bar chart of matching variables broken down by cohort, to aid estimating if exact matching or propensity score matching is feasible. Counts are reporting on a log scale.

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=12, fig.height=8}
cohort_prematch_demo %>% 
  pivot_longer(cols = c(sex_cat, race_eth_cat, age_cat_at_ce, complex_chronic_flag, visit_type_inpatient_or_ed,
         visit_type_outpatient,visit_type_admin_other_telemed), names_to = "match_variable", values_to = "variable_value") %>% 
  group_by(match_variable,
           variable_value,
           cohort_assignment) %>% 
  summarise(n_pats=n_distinct(person_id)) %>% 
  ggplot() +
  geom_bar(aes(x=variable_value, y = n_pats, fill=cohort_assignment, color=cohort_assignment, alpha=0.2), stat="identity", position = "dodge") +
  theme_bw() +
  facet_wrap(~match_variable, scales = "free", ncol = 2) +
  scale_y_continuous(trans="log10") +
  scale_fill_brewer(palette = "Dark2") +
  scale_color_brewer(palette = "Dark2") +
  coord_flip() +
  labs(x="Matching variable value", y="Number patients (log)")

```


## Temporal trends

The aim of this section is to help select sub-time frames, along with using the data from above, to streamline research questions over specific surge periods, or at least become aware of the temporal patterns described by the data.

Remember, we will ultimately be looking forward at future infections of the group/s that we select. This time series can be used both to select index date periods, as well as to hypothesize about what subsequent infection distributions may look like given a spec ific time period for index dates.

The vertical axis shows stacked density distributions of incidence cases of each disease by week, normalized over the total number of instances of each disease over all time.

The final set of 3 plots are supplementary: they break the patients into 3 categories according to how many total unique diseases (of the 3 investigated) a patient had, so either 1, 2, or all 3, and describes the same temporal density trends. The idea here is, do we see a different trend in incidence, for patients who are infected with more things.

TODO

<!-- ```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=12, fig.height=6} -->
<!-- disease_summary_1 %>%  -->
<!--     ggplot() + -->
<!--     geom_bar(aes(x=evidence_week, y=as.numeric(n_week)/as.numeric(total_disease_all_time), fill=disease), stat="identity", -->
<!--              position="stack") + -->
<!--     theme_bw() + -->
<!--     scale_fill_brewer(palette = "Set1")+ -->
<!--     scale_x_date(date_breaks = "months" , date_labels = "%b-%y") + -->
<!--     theme(text = element_text(size=12), -->
<!--           axis.text.x = element_text(angle=90, hjust=1)) + -->
<!--   labs(x="Evidence week", y = "Density") -->
<!--   ## Group by concept and week, and number of coinfections, count  by week, unique patient count per week of each disease -->
<!--   ## Plot: geom_bar(aes(x=week, y = n/r, fill=disease), position="stack") + facet_wrap(~coinfected_pats) -->
<!--   disease_summary_1 %>%  -->
<!--     filter(!is.na(n_diseases_unique)) %>%  -->
<!--     ggplot() + -->
<!--     geom_bar(aes(x=as.Date(evidence_week), y=as.numeric(n_class)/as.numeric(total_disease_all_time), fill=disease), stat="identity", -->
<!--              position="stack") + -->
<!--     facet_wrap(~n_diseases_unique, ncol = 3, scales = "free") + -->
<!--     theme_bw() + -->
<!--     scale_fill_brewer(palette = "Set1")+ -->
<!--     scale_x_date(date_breaks = "months" , date_labels = "%b-%y") + -->
<!--     theme(text = element_text(size=12), -->
<!--           axis.text.x = element_text(angle=90, hjust=1)) + -->
<!--     labs(x="Evidence week", y="Density") -->
<!-- ``` -->

