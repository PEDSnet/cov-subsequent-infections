
---
title: "Subsequent Infections - Full Progress Report "
date: "`r format(Sys.time(), '%m-%d-%y')`"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_collapsed: yes
    toc_float: yes
---

Report for progress on study modeling and analysis for the comparison of the presence of post-acute RSV infection in COVID-positive patients compared to comparison groups (influenza and other acute respiratory infections).

```{r setup, include=FALSE}
# Default taken from R notebook behavior: when knitting, wd will always be location of notebook
base_dir <- '..'
Sys.setenv(PEDSNET_SKIP_REQUEST_EXECUTION=1)
try(source('../site/run.R')) # May not be able to make db connection
#try(source('site/run.R'))

# Set to "local" to read data from ../results, or another value to read from db
data_source <- if_else(config('execution_mode') == 'distribution', 'local', 'not_local')

require(tibble)
require(knitr)
require(kableExtra)
require(readr)
require(table1)
require(ggplot2)
library(GGally)
require(tidyverse)
require(lubridate)
library(wesanderson)
library(survey)
library(survival)
library(WeightIt)
library(cobalt)
library(jtools)
require(cobalt)
require(WeightIt)
require(scattermore)
require(broom)
require(broom.mixed)
require(tableone)

get_results <- function(tbl_name) {
  if (data_source == 'local') {
    rslt <- read_csv(paste0('../results/', tbl_name, '.csv'))
  }
  else {
    rslt <- results_tbl(tbl_name) %>% collect()
  }
  rslt
}


prettify_kable <- function(data, indents = list()) {
  
  if (length(indents)==0) {
      data %>% 
        kbl(digits = 2, format.args = list(big.mark = ',')) %>%
        kable_classic(full_width = F, html_font = "Arial") %>% 
        kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>% 
        column_spec(1, bold = F, border_right = T)
  } else {
      data %>% 
        kbl(digits = 2, format.args = list(big.mark = ',')) %>%
        kable_classic(full_width = F, html_font = "Arial") %>% 
        kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>% 
        add_indent(indents) %>% 
        column_spec(1, bold = F, border_right = T)
  }

  # 
  # data %>% 
  #   kable(digits = 2, format.args = list(big.mark = ',')) %>% 
  #   kable_styling(bootstrap_options = c("striped", "hover")) %>% 
  #   column_spec(1, bold = T, border_right = T)
}

my.render.cont <- function(x) {
  with(stats.apply.rounding(stats.default(x), digits = 6), c("",
    "Mean (SD)" = sprintf("%0.1f (%0.1f)", as.numeric(MEAN), as.numeric(SD)),
    "Median [Q1-Q3]" = sprintf("%0.1f [%0.1f - %0.1f]", as.numeric(MEDIAN), as.numeric(Q1), as.numeric(Q3))
  ))
}

my.render.cat <- function(x) {
  c("", sapply(stats.default(x), function(y) {
    with(
      y,
      sprintf("%s (%0.1f%%)", format(FREQ, big.mark = ","), PCT)
    )
  }))
}

pvalue <- function(x, ...) {
  # Construct vectors of data y, and groups (strata) g
  # from https://cran.r-project.org/web/packages/table1/vignettes/table1-examples.html#example-a-column-of-p-values

  y <- unlist(x)
  g <- factor(rep(1:length(x), times = sapply(x, length)))
  if (is.numeric(y)) {
    # For numeric variables, perform a standard 2-sample t-test
    p <- t.test(y ~ g)$p.value
  } else {
    # For categorical variables, perform a chi-squared test of independence
    p <- chisq.test(table(y, g))$p.value
  }
  # Format the p-value, using an HTML entity for the less-than sign.
  # The initial empty string places the output on the line below the variable label.
  c("", sub("<", "&lt;", format.pval(p, digits = 3, eps = 0.001)))
}

# fron https://rdrr.io/github/junkka/ehahelper/src/R/broom_coxme.R
tidy.coxme <- function(x, exponentiate = FALSE, conf.int = 0.95, ...) {
  beta <- x$coefficients
  nvar <- length(beta)
  nfrail <- nrow(x$var) - nvar
  nn <- c("estimate", "exp()", "std.error", "statistic", "p.value")
  se <- sqrt(diag(as.matrix(x$var))[nfrail + 1:nvar])
  z <- qnorm((1 + conf.int) / 2, 0, 1)
  ret <- data.frame(
    "term" = names(beta),
    "estimate" = beta,
    "std.error" = se,
    "statistic" = beta / se,
    "p.value" = 1 - pchisq((beta / se)^2, 1),
    "conf.low" = beta - z * se,
    "conf.high" = beta + z * se,
    "beta" = beta
  )
  if (exponentiate) {
    ret$estimate <- exp(ret$estimate)
    ret$conf.low <- exp(ret$conf.low)
    ret$conf.high <- exp(ret$conf.high)
  }
  rownames(ret) <- c(1:nrow(ret))
  ret
}
```

# Data RSV
```{r data_RSV, include = FALSE, echo=FALSE, message=FALSE, warning=FALSE}
postacute_min_start_date = as.Date("2022-04-01")
postacute_max_end_date = as.Date("2023-01-01")

cohort_entry_start_date = as.Date("2022-03-01")
cohort_entry_end_date = as.Date("2022-07-01")

cohort_1_label = "rsv_study_cohort"

comparison_group_string = "Influenza"


analytic_dataset <-
  results_tbl(paste0(cohort_1_label, "_analytic_dataset_highrisk")) %>% 
  filter(ce_date >= cohort_entry_start_date,
         ce_date < cohort_entry_end_date)

analytic_dataset_final <-
  analytic_dataset %>% 
  filter(sex_cat != "Other/unknown") %>% 
  filter(is.na(covid_index_date_imputed) | covid_index_date_imputed==0) %>% 
  group_by(person_id) %>% 
  mutate(exclude = max(exclude_for_prior_rsv)) %>% 
  filter(exclude < 1) %>%
  slice_min(rsv_evidence_date, with_ties=FALSE) %>% 
  ungroup() %>% 
  mutate(lab_confirmed_index = ifelse(lab_confirmed==1, "lab confirmed", "dx only")) %>% 
  mutate(lab_confirmed_rsv_outcome = ifelse(lab_confirmed_rsv==1, "lab confirmed RSV", "dx only")) %>% 
  # mutate(visit_span_criteria_rank = as.character(visit_span_criteria_rank)) %>% 
  mutate(hospitalized_at_index = ifelse(hospital_flag==1 & visit_span_criteria_rank=="1", "Hospitalized", "Not hospitalized")) %>% 
  mutate(hospital_flag = as.character(hospital_flag)) %>% 
  mutate(hosp_with_vent = as.character(hosp_with_vent)) %>% 
  mutate(hospitalized_at_index = ifelse(is.na(hospitalized_at_index), "Not hospitalized", hospitalized_at_index)) %>% 
  mutate(hosp_with_vent = ifelse(is.na(hosp_with_vent), "0", hosp_with_vent))  %>% 
  mutate(hospitalized_at_index_detail = ifelse(hospitalized_at_index=="Hospitalized" & hosp_with_vent=="1", "Hospitalized with ventilation", hospitalized_at_index)) %>% collect() %>%
  mutate(pulmonary_respiratory = as.factor(pulmonary_respiratory),
          highrisk_flag = if_else(highrisk_flag, "Yes", "No"))


visit_counts <- results_tbl(paste0(cohort_1_label, "_visit_lookback_counts")) %>% 
  collect()

```

# Data Resp
```{r data_resp, echo = FALSE, output = FALSE, message = FALSE , warning = FALSE}
postacute_min_start_date_resp = as.Date("2021-07-01")
postacute_max_end_date_resp = as.Date("2023-03-01")
  
cohort_entry_start_date_resp = as.Date("2021-06-01")
cohort_entry_end_date_resp = as.Date("2023-01-01")
cohort_entry_end_date_resp = as.Date("2022-10-01")
  
cohort_1_label_resp = "resp_study_cohort"


# description = "covid_flu_3"
# description = "covid_flu_noutil"
# description = "covid_flu_util"
# description = "covid_ari_util"
# description = "covid_ari_ce_week"
# description = "covid_flu_nonexclude"

description_resp = "covid_flu_comparison"
# description = "covid_ari_comparison"
# comparison_group_string = "Respiratory"
comparison_group_string_resp = "Influenza"


analytic_dataset_resp <-
  results_tbl(paste0(cohort_1_label_resp, "_analytic_dataset")) %>% 
  filter(ce_date >= cohort_entry_start_date_resp,
         ce_date < cohort_entry_end_date_resp)

analytic_dataset_final_resp <-
  analytic_dataset_resp %>% 
  filter(sex_cat != "Other/unknown") %>% 
  filter(is.na(covid_index_date_imputed) | covid_index_date_imputed==0) %>% 
  group_by(person_id) %>% # TODO might need to filter earliest resp date or something
  ungroup() %>% 
  mutate(lab_confirmed_index = ifelse(lab_confirmed==1, "lab confirmed", "dx only")) %>% 
  # mutate(visit_span_criteria_rank = as.character(visit_span_criteria_rank)) %>% 
  mutate(hospitalized_at_index = if_else(hospital_flag==1 & visit_span_criteria_rank=="1", "Yes","No")) %>% 
  mutate(hospital_flag = as.character(hospital_flag)) %>% 
  mutate(hosp_with_vent = as.character(hosp_with_vent)) %>% 
  mutate(hospitalized_at_index = if_else(is.na(hospitalized_at_index), "No", hospitalized_at_index)) %>% 
  mutate(hosp_with_vent = ifelse(is.na(hosp_with_vent), "0", hosp_with_vent))  %>% 
  mutate(hospitalized_at_index_detail = ifelse(hospitalized_at_index== "Yes" & hosp_with_vent=="1", "Hospitalized with ventilation", hospitalized_at_index)) %>% 
  mutate(resp_outcome_is_reinfection = case_when(resp_outcome_flu_related=="x" & sub_cohort=="Influenza" ~ "1",
                                                 outcome_covid30d=="1" & sub_cohort=="COVID" ~ "1",
                                                 TRUE ~ "0")) %>% 
  # mutate(rsv_outcome_postacute = ifelse(rsv_occurrence_period == "post acute (15-180 days after index)", 1, 0)) %>% 
  collect()

visit_counts_resp <- results_tbl(paste0(cohort_1_label_resp, "_visit_lookback_counts")) %>%
  collect()

```

# Attrition - RSV cohort

This attrition table considers the cohort entry period to be defined from *March 1, 2022* to *July 1, 2022*. 
This means that the study outcome window will extend from *April 1, 2022* to *January 1, 2023*.


Attrition based on cohort inclusion criteria. Inclusion criteria were computed according to the following rules.

* Patients under 6 years old with at least one visit during cohort entry period (Jan 1 - July 1, 2022, may be tightened as desired)

* Had evidence of either SARS-CoV-2 infection, Influenza, or any other respiratory infection within the cohort entry period

* Had at least 1 visit within 18 months of index date, and at least 1 visit in the 1-6 months following the index date (follow up period)

Index sub-cohort group was selected according to the following logic:

* Select as initial index type and date the *earliest evidence of SARS-CoV-2 or Influenza or other ARI*

* If a patient's index category is an *other ARI* but they *have evidence of SARS-CoV-2 or Influenza within 7 days*, update the index category to SARS-CoV-2/Influenza accordingly, but keep the index date the same as the preliminary ARI diagnosis

* Exclusions:

  * No prior SARS-CoV-2 ever, via test, diagnosis, or serology positive
  
  * No Influenza within pre-acute or acute period (6 months before index)
  
  * No prior RSV (outcome) or RSV within acute period
  
  * No co-infection of Influenza and SARS-Cov-2 within acute period
  


```{r attrition, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=8, fig.height=6}
attrition <- results_tbl(paste0(cohort_1_label, "_attrition")) %>% 
  collect()

#cohort_1_label = "_rsv_study_cohort_"
#cohort_1_label = "rsv_sensitivity_"

attrition_ordered <- attrition %>% 
  mutate(ordering = case_when(
    cohort == "Patients under 6 years old with at least 1 visit during CE period" ~ 1,
    cohort == "Had at least 1 of COVID, influenza, and/or other respiratory infection event during CE period" ~ 2,
    cohort == "Had COVID during CE period" ~ 3,
    cohort == "Had influenza during CE period" ~ 4,
    cohort == "Had other respiratory infection during CE period" ~ 5,
    cohort == "Meets utilization inclusion criteria" ~ 6,
    cohort == "Not excluded due to overlapping index infections" ~ 7,
    cohort == "Final COVID sub-cohort" ~ 8,
    cohort == "Final Influenza sub-cohort" ~ 9,
    cohort == "Final Other respiratory sub-cohort" ~ 10,
    TRUE ~ 0
  ))


attrition_ordered %>%
  select("Attrition step" = cohort, persons, ordering) %>%
  filter(ordering > 0) %>%
  arrange(ordering) %>%
  select(-ordering) %>%
  prettify_kable(c(3, 4, 5, 8, 9, 10))
```

# Attrition - Any respiratory infection cohort
This attrition table considers the cohort entry period to be defined from *June 1, 2021* to *March 1, 2023*. 
This means that the study outcome window will extend from *July 1, 2021* to *March 1, 2023*.


Attrition based on cohort inclusion criteria. Inclusion criteria were computed according to the following rules.

* Patients under 6 years old with at least one visit during cohort entry period (June 1, 2021 to February 01, 2023 may be tightened as desired)

* Had evidence of either SARS-CoV-2 infection or Influenza infection within the cohort entry period

* Had at least 1 visit within 18 months of index date, and at least 1 visit in the 1-6 months following the index date (follow up period)


* Exclusions:

  * No prior SARS-CoV-2 ever, via test, diagnosis, or serology positive
  
  * No Influenza within pre-acute or acute period (6 months before index)
  
  * No prior RSV (outcome) or RSV within acute period
  
  * No co-infection of Influenza and SARS-Cov-2 within acute period

```{r attrition_resp, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=8, fig.height=6}
attrition_resp <- results_tbl(paste0(cohort_1_label_resp, "_attrition")) %>% 
  collect()

attrition_ordered_resp <- attrition_resp %>% 
  mutate(ordering = case_when(
    cohort == "Patients under 6 years old with at least 1 visit during CE period" ~ 1,
    cohort == "Had at least 1 of COVID, influenza infection event during CE period" ~ 2,
    cohort == "Had COVID during CE period" ~ 3,
    cohort == "Had influenza during CE period" ~ 4,
    cohort == "Meets utilization inclusion criteria" ~ 5,
    cohort == "Not excluded due to overlapping index infections" ~ 6,
    cohort == "Final COVID sub-cohort" ~ 7,
    cohort == "Final Influenza sub-cohort" ~9,
    #cohort == "Final Other respiratory sub-cohort" ~ 10,
    TRUE ~ 0
  ))


attrition_ordered_resp %>%
  select("Attrition step" = cohort, persons, ordering) %>%
  filter(ordering > 0) %>%
  arrange(ordering) %>%
  select(-ordering) %>%
  prettify_kable(c(3, 4, 7, 8))
```

# Table 1 - RSV cohort

```{r table1_rsv, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=8, fig.height=6}
  
table1_rsv <- analytic_dataset_final %>% 
                mutate(age_cat_at_ce = factor(age_cat_at_ce, levels = c("<6 months", "6m-1y old", "1-2y old", "2-3y old", "3-4y old", "4-5y old")),
                       race_eth_cat = recode(race_eth_cat, "NH_White" = "Non-Hispanic White", 
                                                           "NH_Asian/PI" = "Non-Hispanic Asian/PI",
                                                           "NH_Black/AA" = "Non-Hispanic Black",
                                                           "NH_Multiple" = "Non-Hispanic Multiple"), 
                       insurance_class = recode(insurance_class, "private" = "Private", "public" = "Public", "other/unknown" = "Other"),
                       insurance_class = factor(insurance_class, levels = c("Public", "Private", "Other")),
                       across(c("util_inpatient", "util_outpatient", "util_ed", "util_other"), ~recode(.x, "high_utilizer" = "High Utilizer", 
                                                                "low_utilizer" = "Low Utilizer", 
                                                                "moderate_utilizer" = "Moderate Utilizer", 
                                                                "no_visits" = "No Visits")), 
                       util_inpatient = factor(util_inpatient, levels = c("High Utilizer", "Low Utilizer", "No Visits")), 
                       across(c("util_outpatient", "util_ed", "util_other"), ~factor(.x, levels = c("High Utilizer", "Moderate Utilizer", "Low Utilizer", "No Visits"))), 
                       lab_confirmed_index = recode(lab_confirmed_index, "dx only" = "Diagnosis only", "lab confirmed" = "Lab confirmed"))%>%
  mutate(hospitalized_at_index = if_else(hospitalized_at_index == "Not hospitalized", "No", "Yes"),
         pulmonary_respiratory = if_else(pulmonary_respiratory == 1, "Yes" ,  "No"))
label(table1_rsv$age_cat_at_ce) = "Age categories"
label(table1_rsv$sex_cat) = "Gender"
label(table1_rsv$race_eth_cat) = "Race/ethnicity"
label(table1_rsv$insurance_class) = "Insurance class"
label(table1_rsv$util_inpatient) = "Prior inpatient visit frequency*"
label(table1_rsv$util_outpatient) = "Prior outpatient visit frequency*"
label(table1_rsv$util_ed) = "Prior ED visit frequency*"
label(table1_rsv$util_other) = "Prior other visit frequency*"
label(table1_rsv$lab_confirmed_index) = "Test confirm diagnosis"
label(table1_rsv$highrisk_flag )=  "Had at least one high risk condition"
label(table1_rsv$pulmonary_respiratory )=  "PMCA"
label(table1_rsv$hospitalized_at_index )=  "Hospitalized for index infection"
table1(~ age_cat_at_ce + 
         sex_cat + race_eth_cat + 
         insurance_class + 
         util_inpatient +
         util_outpatient +
         util_ed + 
         util_other +
         lab_confirmed_index +
         hospitalized_at_index + 
         pulmonary_respiratory + 
         highrisk_flag | sub_cohort, 
       data = table1_rsv,
       footnote = c("PI: Pacific Islander", "*Low, moderate, and high utilizers correspond to the 33th, 66th, and 97.5th percentile of the number of visits in the cohort"))
```

# Table 1 - Any respiratory infection cohort
```{r table1_resp, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=8, fig.height=6}
  
table1_resp <- analytic_dataset_final_resp %>% 
                mutate(age_cat_at_ce = factor(age_cat_at_ce, levels = c("<6 months", "6m-1y old", "1-2y old", "2-3y old", "3-4y old", "4-5y old")),
                       race_eth_cat = recode(race_eth_cat, "NH_White" = "Non-Hispanic White", 
                                                           "NH_Asian/PI" = "Non-Hispanic Asian/PI",
                                                           "NH_Black/AA" = "Non-Hispanic Black",
                                                           "NH_Multiple" = "Non-Hispanic Multiple"), 
                       insurance_class = recode(insurance_class, "private" = "Private", "public" = "Public", "other/unknown" = "Other"),
                       insurance_class = factor(insurance_class, levels = c("Public", "Private", "Other")),
                       across(c("util_inpatient", "util_outpatient", "util_ed", "util_other"), ~recode(.x, "high_utilizer" = "High Utilizer", 
                                                                "low_utilizer" = "Low Utilizer", 
                                                                "moderate_utilizer" = "Moderate Utilizer", 
                                                                "no_visits" = "No Visits")), 
                       across(c("util_inpatient", "util_outpatient", "util_ed", "util_other"), ~factor(.x, levels = c("High Utilizer", "Moderate Utilizer", "Low Utilizer", "No Visits"))), 
                       lab_confirmed_index = recode(lab_confirmed_index, "dx only" = "Diagnosis only", "lab confirmed" = "Lab confirmed"),
                       pulmonary_respiratory = as.factor(pulmonary_respiratory),
                       pulmonary_respiratory = if_else(pulmonary_respiratory == 1, "Yes" ,  "No"))
label(table1_resp$age_cat_at_ce) = "Age categories"
label(table1_resp$sex_cat) = "Gender"
label(table1_resp$race_eth_cat) = "Race/ethnicity"
label(table1_resp$insurance_class) = "Insurance class"
label(table1_resp$util_inpatient) = "Prior inpatient visit frequency*"
label(table1_resp$util_outpatient) = "Prior outpatient visit frequency*"
label(table1_resp$util_ed) = "Prior ED visit frequency*"
label(table1_resp$lab_confirmed_index) = "Test confirm diagnosis"
label(table1_resp$hospitalized_at_index) = "Hospitalized at index visit"
label(table1_resp$pulmonary_respiratory )=  "PMCA"
table1(~ age_cat_at_ce + 
         sex_cat + race_eth_cat + 
         insurance_class + 
         util_inpatient +
         util_outpatient +
         util_ed + 
         #util_other +
         #visit_type_inpatient +
         #visit_type_outpatient +
         #visit_type_ed + 
         #visit_type_other +
         lab_confirmed_index +
         hospitalized_at_index  +
         #hospitalized_at_index_detail +
         pulmonary_respiratory | sub_cohort,
       data = table1_resp,
       footnote = c("PI: Pacific Islander", "*Low, moderate, and high utilizers correspond to the 33th, 66th, and 97.5th percentile of the number of visits in the cohort"))
```

# Figure_1: Epi curves with co-infections
```{r figure_1_with_coinfections, echo = FALSE, warning = FALSE, message = FALSE, fig.width=12, fig.height=8}
analytic_dataset_final %>% 
  select(ce_date, rsv_evidence_date, sub_cohort, days_from_index_to_rsv) %>% 
  filter(sub_cohort != "Respiratory") %>% 
  filter(!is.na(days_from_index_to_rsv)) %>% 
  mutate(plot_cohort = case_when(
    days_from_index_to_rsv==0 & sub_cohort == "COVID" ~ "Cov+RSV",
    days_from_index_to_rsv==0 & sub_cohort == "Influenza" ~ "Flu+RSV",
    days_from_index_to_rsv==0 & sub_cohort == "Respiratory" ~ "ARI+RSV",
    TRUE ~ sub_cohort
  )) %>% 
  pivot_longer(cols=c("ce_date", "rsv_evidence_date"), names_to = "Event", values_to = "dates") %>% 
  #filter(!(Event== "rsv_evidence_date"& plot_cohort %in% c("Cov+RSV","Flu+RSV")))%>%
  ggplot() +
  # geom_histogram(aes(x=dates, fill = plot_cohort), alpha=0.9) +
  # geom_density(aes(x=dates, fill = plot_cohort, color = plot_cohort), alpha=0.75, position="dodge") +
  facet_wrap(~Event, scales = "free_y", ncol=1) +
  geom_histogram(aes(x=dates, fill = plot_cohort, color = plot_cohort), alpha=0.75, position="dodge") +
  #eom_histogram(aes(x=rsv_evidence_date, fill = sub_cohort, color = "RSV outcome"), alpha=0.5)+
  # scale_color_brewer(palette = "Set1") +
  scale_fill_brewer(palette = "Set1")+
  scale_color_brewer(palette = "Set1") +
  # scale_fill_manual(values = wes_palette("FantasticFox1", n=4, type = "continuous")) +
  # scale_color_manual(values = wes_palette("FantasticFox1", n=4, type = "continuous")) +
  theme_bw() +
  theme(legend.position = "top") 
```

# Figure_1: Epi curves without co-infections
```{r figure_1_no_coinfections, echo = FALSE, warning = FALSE, message = FALSE, fig.width=12, fig.height=8}
analytic_dataset_final %>% 
  select(ce_date, rsv_evidence_date, sub_cohort, days_from_index_to_rsv) %>% 
  filter(sub_cohort != "Respiratory") %>% 
  filter(!is.na(days_from_index_to_rsv)) %>% 
  mutate(plot_cohort = case_when(
    days_from_index_to_rsv==0 & sub_cohort == "COVID" ~ "Cov+RSV",
    days_from_index_to_rsv==0 & sub_cohort == "Influenza" ~ "Flu+RSV",
    days_from_index_to_rsv==0 & sub_cohort == "Respiratory" ~ "ARI+RSV",
    TRUE ~ sub_cohort
  )) %>% 
  pivot_longer(cols=c("ce_date", "rsv_evidence_date"), names_to = "Event", values_to = "dates") %>% 
  filter(!(Event== "rsv_evidence_date"& plot_cohort %in% c("Cov+RSV","Flu+RSV")))%>%
  ggplot() +
  # geom_histogram(aes(x=dates, fill = plot_cohort), alpha=0.9) +
  # geom_density(aes(x=dates, fill = plot_cohort, color = plot_cohort), alpha=0.75, position="dodge") +
  facet_wrap(~Event, scales = "free_y", ncol=1) +
  geom_histogram(aes(x=dates, fill = plot_cohort, color = plot_cohort), alpha=0.75, position="dodge") +
  #eom_histogram(aes(x=rsv_evidence_date, fill = sub_cohort, color = "RSV outcome"), alpha=0.5)+
  # scale_color_brewer(palette = "Set1") +
  scale_fill_brewer(palette = "Set1")+
  scale_color_brewer(palette = "Set1") +
  # scale_fill_manual(values = wes_palette("FantasticFox1", n=4, type = "continuous")) +
  # scale_color_manual(values = wes_palette("FantasticFox1", n=4, type = "continuous")) +
  theme_bw() +
  theme(legend.position = "top") 
```

# Figure 2
## Figure 2a: Outcome: RSV Infection within 0-60, 1-60, 15-180 days ---- Adjustments: None, weighted/adjusted

```{r figure_2a, echo = FALSE, warning = FALSE, message = FALSE, fig.width=12, fig.height=6}

models = list()

outcome_0_60 = "outcome_rsv_0_to_60"
comparison_group = comparison_group_string

formula_no_pulmonary = "~ `SARS-CoV-2 Infection: ` + `Age groups: ` + `Race: ` + `Gender: ` + `Hospitalized for index infection: ` +  util_inpatient +  util_outpatient +  util_ed + util_other"
# iptw_0_60 <- analytic_dataset_final %>%
#   do_iptw(cohort_entry_start_date = cohort_entry_start_date,
#           comparison_cohort = comparison_group,
#           weight_formula = "covid~age_group+sex_cat+race_eth_cat+ce_week_factor+pulmonary_respiratory",
#           iptw_description = paste0("covid_", comparison_group, "_", outcome_0_60))
df_0_60 <- results_tbl( paste0(paste0("covid_", comparison_group, "_", outcome_0_60),'_tabc')) %>% 
  collect()
# df_0_60 <- results_tbl( paste0(paste0("covid_", comparison_group, "_", outcome_0_60, "_NN"),'_tabc')) %>%
#   collect()

df_0_60 <- df_0_60 %>% mutate(hospitalized_at_index = if_else(hospitalized_at_index == "Hospitalized", "Yes", "No"), 
                              across(c("util_inpatient", "util_outpatient", "util_other", "util_ed"), 
                                     ~recode(.x, "no_visits" = "None", "low_utilizer" = "Low","moderate_utilizer" = "Moderate", "high_utilizer" = "High")),
                              pulmonary_respiratory = recode(pulmonary_respiratory, "0" = "No", "1" = "Yes")) %>%
  rename(`Age groups: ` = age_group,
         `Hospitalized for index infection: ` = hospitalized_at_index,
         # `Prior inpatient visit frequency: ` = util_inpatient,
         # `Prior outpatient visit frequency: ` = util_outpatient,
         # `Prior ER visit frequency: ` = util_ed,
         # `Prior other visit frequency: ` = util_other,
         `Pulmonary Respiratory: ` = pulmonary_respiratory,
         `Race: ` = race_eth_cat,
         `Gender: ` = sex_cat,
         `SARS-CoV-2 Infection: ` = covid)
models$unw_unadj_0_to_60 <- run_logistic_regression(df = df_0_60,
                                                    model_formula = paste0(outcome_0_60, " ~ `SARS-CoV-2 Infection: `"),
                                                    weight_method = "none")

models$w_adj_0_to_60 <- run_logistic_regression(df = df_0_60,
                                                model_formula = paste0(outcome_0_60,
                                                                       formula_no_pulmonary), # + `Pulmonary Respiratory: `"), 
                                                weight_method = "lr")

outcome_1_60 = "outcome_rsv_1_to_60"
comparison_group = comparison_group_string

# iptw_1_60 <- analytic_dataset_final %>%
#    do_iptw(cohort_entry_start_date = cohort_entry_start_date,
#            comparison_cohort = comparison_group,
#            weight_formula = "covid~age_group+sex_cat+race_eth_cat+ce_week_factor",
#            iptw_description = paste0("covid_", comparison_group, "_", outcome_1_60, "_NN"))

# df_1_60 <- results_tbl( paste0(paste0("covid_", comparison_group, "_", outcome_1_60, "_NN"),'_tabc')) %>%
#   collect()
df_1_60 <- results_tbl( paste0(paste0("covid_", comparison_group, "_", outcome_1_60),'_tabc')) %>% 
  collect()

df_1_60 <- df_1_60 %>%  mutate(hospitalized_at_index = if_else(hospitalized_at_index == "Hospitalized", "Yes", "No"), 
                              across(c("util_inpatient", "util_outpatient", "util_other", "util_ed"), 
                                     ~recode(.x, "no_visits" = "None", "low_utilizer" = "Low","moderate_utilizer" = "Moderate", "high_utilizer" = "High")),
                              pulmonary_respiratory = recode(pulmonary_respiratory, "0" = "No", "1" = "Yes")) %>%
  rename(`Age groups: ` = age_group,
         `Hospitalized for index infection: ` = hospitalized_at_index,
         # `Prior inpatient visit frequency: ` = util_inpatient,
         # `Prior outpatient visit frequency: ` = util_outpatient,
         # `Prior ER visit frequency: ` = util_ed,
         # `Prior other visit frequency: ` = util_other,
         `Pulmonary Respiratory: ` = pulmonary_respiratory,
         `Race: ` = race_eth_cat,
         `Gender: ` = sex_cat,
         `SARS-CoV-2 Infection: ` = covid)

models$unw_unadj_1_to_60 <- run_logistic_regression(df = df_1_60,
                                                    model_formula = paste0(outcome_1_60, " ~ `SARS-CoV-2 Infection: `"),
                                                    weight_method = "none")

models$w_adj_1_to_60 <- run_logistic_regression(df = df_1_60,
                                                model_formula = paste0(outcome_1_60,
                                                                       formula_no_pulmonary), # + `Pulmonary Respiratory: `"), 
                                                weight_method = "lr")


outcome_30_180 = "outcome_rsv_30_to_180"
comparison_group = comparison_group_string

rsv_iptw_30_180 <- analytic_dataset_final %>%
  do_iptw(cohort_entry_start_date = cohort_entry_start_date,
          comparison_cohort = comparison_group,
          weight_formula = "covid~age_group+sex_cat+race_eth_cat+ce_week_factor",
          iptw_description = paste0("covid_", comparison_group, "_", outcome_30_180))

df_30_180 <- results_tbl( paste0(paste0("covid_", comparison_group, "_", outcome_30_180),'_tabc')) %>%
  collect()

df_30_180 <- df_30_180 %>%  mutate(hospitalized_at_index = if_else(hospitalized_at_index == "Hospitalized", "Yes", "No"), 
                              across(c("util_inpatient", "util_outpatient", "util_other", "util_ed"), 
                                     ~recode(.x, "no_visits" = "None", "low_utilizer" = "Low","moderate_utilizer" = "Moderate", "high_utilizer" = "High")),
                              pulmonary_respiratory = recode(pulmonary_respiratory, "0" = "No", "1" = "Yes")) %>%
  rename(`Age groups: ` = age_group,
         `Hospitalized for index infection: ` = hospitalized_at_index,
         # `Prior inpatient visit frequency: ` = util_inpatient,
         # `Prior outpatient visit frequency: ` = util_outpatient,
         # `Prior ER visit frequency: ` = util_ed,
         # `Prior other visit frequency: ` = util_other,
         `Pulmonary Respiratory: ` = pulmonary_respiratory,
         `Race: ` = race_eth_cat,
         `Gender: ` = sex_cat,
         `SARS-CoV-2 Infection: ` = covid)


models$unw_unadj_30_to_180 <- run_logistic_regression(df = df_30_180,
                                                      model_formula = paste0(outcome_30_180, " ~ `SARS-CoV-2 Infection: `"),
                                                      weight_method = "none")

models$w_adj_30_to_180 <- run_logistic_regression(df = df_30_180,
                                                  model_formula = paste0(outcome_30_180,
                                                                          formula_no_pulmonary), # + `Pulmonary Respiratory: `"), 
                                                  weight_method = "lr")

var_to_omit <- c("(Intercept)", "util_inpatientNone", "util_inpatientLow", "util_inpatientHigh", "util_inpatientModerate",
                 "util_outpatientNone", "util_outpatientLow", "util_outpatientHigh", "util_outpatientModerate",
                 "util_edNone", "util_edLow", "util_edHigh", "util_edModerate",
                 "util_otherNone", "util_otherLow", "util_otherHigh", "util_otherModerate")

plot_summs(models$unw_unadj_0_to_60,
           models$w_adj_0_to_60,
           models$unw_unadj_1_to_60,
           models$w_adj_1_to_60,
           models$unw_unadj_30_to_180,
           models$w_adj_30_to_180,
           omit.coefs = var_to_omit, 
           model.names = c("RSV 0-60d: Unweighted, unadjusted",
                           "RSV 0-60d: Weighted, adjusted",
                           "RSV 1-60d: Unweighted, unadjusted",
                           "RSV 1-60d: Weighted, adjusted",
                           "RSV 15-180d: Unweighted, unadjusted",
                           "RSV 15-180d: Weighted, adjusted"),
           # "Weighted, adjusted for CE week"),
           exp = TRUE)
ggsave("figures/Figure_2a_rsv_3periods.png", "width" = 20, "height" =10, "units" = "cm")

export_summs(models$unw_unadj_0_to_60,
             models$w_adj_0_to_60,
             models$unw_unadj_1_to_60,
             models$w_adj_1_to_60,
             models$unw_unadj_30_to_180,
             models$w_adj_30_to_180,
             omit.coefs = var_to_omit,  
             model.names = c("RSV 0-60d: Unweighted, unadjusted",
                             "RSV 0-60d: Weighted, adjusted",
                             "RSV 1-60d: Unweighted, unadjusted",
                             "RSV 1-60d: Weighted, adjusted",
                             "RSV 15-180d: Unweighted, unadjusted",
                             "RSV 15-180d: Weighted, adjusted"),
             # "Weighted, adjusted for CE week"),
             exp = TRUE)

```

## Figure 2b: Subsequent Respiratory infection within 30-180 days **Including covid, or flu, ANY respiratory infection within 30-180 days**

```{r sub_resp_infection_excluding_covid, echo = FALSE, output = FALSE, message = FALSE , warning = FALSE}

# TODO really need to figure out what the deal with utilization is
outcome_ari = "resp30d_or_covid30d"
comparison_group_string_ari = "Influenza"
comparison_group_ari = comparison_group_string_ari

ari_iptw_30_180 <- analytic_dataset_final_resp %>%
    mutate(ce_month = floor_date(ce_date, "month")) %>% 
  mutate(ce_month_s = as.character(ce_month)) %>% 
  filter(resp_outcome_is_reinfection=="0") %>% # TODO allow for re-infection
  mutate(resp30d_or_covid30d = case_when(outcome_resp30d==1 ~ 1,
                                         outcome_covid30d==1 ~ 1,
                                         TRUE ~ 0)) %>% 
  do_iptw(cohort_entry_start_date = cohort_entry_start_date,
          comparison_cohort = comparison_group,
          weight_formula = "covid~age_group+sex_cat+race_eth_cat+pulmonary_respiratory+hospitalized_at_index+ce_week_factor", ## PULMONARY_RESP?
          iptw_description = paste0("resp_notime_w", comparison_group_ari, "_", outcome_ari))

dataset_iptw_ari <- results_tbl( paste0(paste0("resp_notime_w", comparison_group_ari, "_", outcome_ari),'_tabc')) %>%
  collect()

dataset_iptw_ari <- dataset_iptw_ari %>% mutate(across(c("util_inpatient", "util_outpatient", "util_other", "util_ed"), 
                                     ~recode(.x, "no_visits" = "None", "low_utilizer" = "Low","moderate_utilizer" = "Moderate", "high_utilizer" = "High")),
                              pulmonary_respiratory = recode(pulmonary_respiratory, "0" = "No", "1" = "Yes")) %>%
  rename(`Age groups: ` = age_group,
         `Hospitalized for index infection: ` = hospitalized_at_index,
         # `Prior inpatient visit frequency: ` = util_inpatient,
         # `Prior outpatient visit frequency: ` = util_outpatient,
         # `Prior ER visit frequency: ` = util_ed,
         # `Prior other visit frequency: ` = util_other,
         `Pulmonary Respiratory: ` = pulmonary_respiratory,
         `Race: ` = race_eth_cat,
         `Gender: ` = sex_cat,
         `SARS-CoV-2 Infection: ` = covid)

models_ari = list()

models_ari$model_unadjusted <- run_logistic_regression(df = dataset_iptw_ari,
                                                       model_formula = paste0(outcome_ari, " ~ `SARS-CoV-2 Infection: `"),
                                                       weight_method = "none")

models_ari$model_adjusted <- run_logistic_regression(df = dataset_iptw_ari,
                                                         model_formula = paste0(outcome_ari,
                                                                               formula_no_pulmonary, " + `Pulmonary Respiratory: `"), 
                                                         weight_method = "none")

models_ari$model_weighted_unadjusted <- run_logistic_regression(df = dataset_iptw_ari,
                                                       model_formula = paste0(outcome_ari, " ~ `SARS-CoV-2 Infection: `"),
                                                       weight_method = "lr_s")

# TODO something is wrong with inpatient
models_ari$model_weighted_adjusted <- run_logistic_regression(df = dataset_iptw_ari,
                                                         model_formula = paste0(outcome_ari,
                                                                                formula_no_pulmonary, " + `Pulmonary Respiratory: `"), 
                                                         weight_method = "lr_s")

```

```{r figure2b_including_covid, echo = FALSE, warning = FALSE, message = FALSE, fig.width=12, fig.height=6}

p <- plot_summs(models_ari$model_unadjusted,
           models_ari$model_adjusted,
           models_ari$model_weighted_unadjusted,
           models_ari$model_weighted_adjusted,
           omit.coefs = var_to_omit,  
           # models$model_weighted_adjusted_time,
           model.names = c("Unweighted, unadjusted",
                           "Unweighted, adjusted",
                           "Weighted (LR), unadjusted",
                           "Weighted (LR), adjusted"),
                           # "Weighted, adjusted for CE week"),
           exp = TRUE)
ggsave("figures/Figure_2b_ari_with_covid_30_180.png", "width" = 20, "height" =10, "units" = "cm")

export_summs(models_ari$model_unadjusted,
           models_ari$model_adjusted,
           models_ari$model_weighted_unadjusted,
           models_ari$model_weighted_adjusted,
           # models$model_weighted_adjusted_time,
           model.names = c("Unweighted, unadjusted",
                           "Unweighted, adjusted",
                           "Weighted (LR), unadjusted",
                           "Weighted (LR), adjusted"),
                           # "Weighted, adjusted for CE week"),
           exp = TRUE)

```

## Figure 2c: Subsequent General (any) infection within 30-180 days inlcuding covid

```{r general_infection_with_covid_30_180, echo = FALSE, output = FALSE, message = FALSE , warning = FALSE}

# TODO really need to figure out what the deal with utilization is
# Of I know why

outcome = "outcome_general30d"
comparison_group_string_resp = "Influenza"
comparison_group = comparison_group_string_resp

any_inf_iptw_flu_30_180 <- analytic_dataset_final_resp %>%
  filter(resp_outcome_is_reinfection=="0") %>% # TODO allow for re-infection
  do_iptw(cohort_entry_start_date = cohort_entry_start_date_resp,
          comparison_cohort = comparison_group,
          weight_formula = "covid~age_group+sex_cat+race_eth_cat+ce_week_factor+pulmonary_respiratory",
          iptw_description = paste0("resp_study_covid_", comparison_group, "_", outcome))

dataset_with_iptw <- results_tbl( paste0(paste0("resp_study_covid_", comparison_group, "_", outcome),'_tabc')) %>%
  collect()
dataset_with_iptw <- dataset_with_iptw %>%  mutate(across(c("util_inpatient", "util_outpatient", "util_other", "util_ed"), 
                                     ~recode(.x, "no_visits" = "None", "low_utilizer" = "Low","moderate_utilizer" = "Moderate", "high_utilizer" = "High")),
                              pulmonary_respiratory = recode(pulmonary_respiratory, "0" = "No", "1" = "Yes")) %>%
  rename(`Age groups: ` = age_group,
         `Hospitalized for index infection: ` = hospitalized_at_index,
         # `Prior inpatient visit frequency: ` = util_inpatient,
         # `Prior outpatient visit frequency: ` = util_outpatient,
         # `Prior ER visit frequency: ` = util_ed,
         # `Prior other visit frequency: ` = util_other,
         `Pulmonary Respiratory: ` = pulmonary_respiratory,
         `Race: ` = race_eth_cat,
         `Gender: ` = sex_cat,
         `SARS-CoV-2 Infection: ` = covid)

models = list()

models$model_unweighted_unadjusted <- run_logistic_regression(df = dataset_with_iptw,
                                                       model_formula = paste0(outcome, " ~ `SARS-CoV-2 Infection: `"),
                                                       weight_method = "none")

models$model_unweighted_adjusted <- run_logistic_regression(df = dataset_with_iptw,
                                                         model_formula = paste0(outcome,
                                                                                formula_no_pulmonary, " + `Pulmonary Respiratory: `"), 
                                                         weight_method = "none")

models$model_weighted_unadjusted <- run_logistic_regression(df = dataset_with_iptw,
                                                       model_formula = paste0(outcome, " ~ `SARS-CoV-2 Infection: `"),
                                                       weight_method = "lr")

# TODO something is wrong with inpatient
models$model_weighted_adjusted <- run_logistic_regression(df = dataset_with_iptw,
                                                         model_formula = paste0(outcome,
                                                                              formula_no_pulmonary, " + `Pulmonary Respiratory: `"), 
                                                         weight_method = "lr")

# models$model_weighted_adjusted_time <- run_logistic_regression(df = dataset_with_iptw,
#                                                          model_formula = paste0(outcome,
#                                                                                 " ~ `SARS-CoV-2 Infection: ` + `Age groups: ` + `Race: ` + `Gender: ` + `Hospitalized for index infection: ` + `Prior inpatient visit frequency: `+ `Prior outpatient visit frequency: ` + `Prior ER visit frequency: ` + `Prior other visit frequency: ` + `Pulmonary Respiratory: ` + ce_week_factor"),
#                                                          weight_method = "lr")

```

```{r figure_2c, echo = FALSE, warning = FALSE, message = FALSE, fig.width=12, fig.height=6}

plot_summs(models$model_unweighted_unadjusted,
           models$model_unweighted_adjusted,
           models$model_weighted_unadjusted,
           models$model_weighted_adjusted,
           # models$model_weighted_adjusted_time,
           omit.coefs = var_to_omit,  
           model.names = c("Unweighted, unadjusted",
                           "Unweighted, adjusted",
                           "Weighted (LR), unadjusted",
                           "Weighted (LR), adjusted"),
                           # "Weighted, adjusted for CE week"),
           exp = TRUE)
ggsave("figures/Figure_2c_general_30_180.png", "width" = 20, "height" =10, "units" = "cm")

export_summs(models$model_unweighted_unadjusted,
           models$model_unweighted_adjusted,
           models$model_weighted_unadjusted,
           models$model_weighted_adjusted,
           # models$model_weighted_adjusted_time,
           model.names = c("Unweighted, unadjusted",
                           "Unweighted, adjusted",
                           "Weighted (LR), unadjusted",
                           "Weighted (LR), adjusted"),
                           # "Weighted, adjusted for CE week"),
           exp = TRUE)



```


# Figure 3:
## Figure 3a: Weighted vs. unweighted propensity score **RSV infection** 30-180 days

```{r figure_3a, echo = FALSE, warning = FALSE, message = FALSE, fig.width=12, fig.height=15}
rsv_iptw_30_180$love_plot
ggsave("figures/Figure_3a_rsv_30_180.png", width = 6.5, height = 10, unit = "in")
```

## Figure 3b: Weighted vs. unweighted propensity score **Any respiratory infection including Covid** 30-180 days

```{r figure_3b, echo = FALSE, warning = FALSE, message = FALSE, fig.width=12, fig.height =20}
ari_iptw_30_180$love_plot
ggsave("figures/Figure_3b_ari_30_180.png", width = 6.5, height = 10, unit = "in")
```

## Figure 3c: Weighted vs. unweighted propensity score **Any general infection within 30-180 days including covid**
```{r figure_3c_no_covid, echo = FALSE, warning = FALSE, message = FALSE, fig.width=12, fig.height=20}
any_inf_iptw_flu_30_180$love_plot
ggsave("figures/Figure_3c_general_30_180.png", width = 6.5, height = 10, unit = "in")
```

# Figure 4a: RSV within 15-300 days (past post-acute)

```{r rsv_15_300, echo = FALSE, output = FALSE, message = FALSE , warning = FALSE}

outcome_15_300 = "outcome_rsv_15_to_300"
comparison_group = "Influenza"

# iptw_flu_15_300 <- analytic_dataset_final %>%
#   mutate(exclude = case_when( is.na(days_from_index_to_rsv) ~ 0,
#                               days_from_index_to_rsv >= 15 ~ 0,
#                               TRUE ~ 1)) %>%
#   filter(exclude==0) %>%
#   do_iptw(cohort_entry_start_date = cohort_entry_start_date,
#           comparison_cohort = comparison_group,
#           weight_formula = "covid~age_group+sex_cat+race_eth_cat+ce_week_factor",
#           iptw_description = paste0("covid_", comparison_group, "_", outcome_15_300))

rsv_iptw_15_300 <- results_tbl( paste0(paste0("covid_", comparison_group, "_", outcome_15_300),'_tabc')) %>% collect()
models_rsv_15_300 = list()
rsv_iptw_15_300 <- rsv_iptw_15_300 %>% mutate(hospitalized_at_index = if_else(hospitalized_at_index == "Hospitalized", "Yes", "No"), 
                              across(c("util_inpatient", "util_outpatient", "util_other", "util_ed"), 
                                     ~recode(.x, "no_visits" = "None", "low_utilizer" = "Low","moderate_utilizer" = "Moderate", "high_utilizer" = "High")),
                              pulmonary_respiratory = recode(pulmonary_respiratory, "0" = "No", "1" = "Yes")) %>%
  rename(`Age groups: ` = age_group,
         `Hospitalized for index infection: ` = hospitalized_at_index,
         # `Prior inpatient visit frequency: ` = util_inpatient,
         # `Prior outpatient visit frequency: ` = util_outpatient,
         # `Prior ER visit frequency: ` = util_ed,
         # `Prior other visit frequency: ` = util_other,
         `Pulmonary Respiratory: ` = pulmonary_respiratory,
         `Race: ` = race_eth_cat,
         `Gender: ` = sex_cat,
         `SARS-CoV-2 Infection: ` = covid)

models_rsv_15_300$model_unweighted_unadjusted <- run_logistic_regression(df = rsv_iptw_15_300,
                                                       model_formula = paste0(outcome_15_300, " ~ `SARS-CoV-2 Infection: `"),
                                                       weight_method = "none")

models_rsv_15_300$model_unweighted_adjusted <- run_logistic_regression(df = rsv_iptw_15_300,
                                                         model_formula = paste0(outcome_15_300,
                                                                                formula_no_pulmonary), #, " + `Pulmonary Respiratory: `"), 
                                                         weight_method = "none")

models_rsv_15_300$model_weighted_unadjusted <- run_logistic_regression(df = rsv_iptw_15_300,
                                                       model_formula = paste0(outcome_15_300, " ~ `SARS-CoV-2 Infection: `"),
                                                       weight_method = "lr")

models_rsv_15_300$model_weighted_adjusted <- run_logistic_regression(df = rsv_iptw_15_300,
                                                         model_formula = paste0(outcome_15_300,
                                                                               formula_no_pulmonary), #, " + `Pulmonary Respiratory: `"), 
                                                         weight_method = "lr")

# models_rsv_15_300$model_weighted_adjusted_time <- run_logistic_regression(df = rsv_iptw_15_300,
#                                                          model_formula = paste0(outcome_15_300,
#                                                                                 formula_no_pulmonary, " + `Pulmonary Respiratory: ` + ce_week_factor"),
#                                                          weight_method = "lr")

```

```{r figure_4a, echo = FALSE, warning = FALSE, message = FALSE, fig.width=12, fig.height=6}

plot_summs(models_rsv_15_300$model_unweighted_unadjusted,
           models_rsv_15_300$model_unweighted_adjusted,
           models_rsv_15_300$model_weighted_unadjusted,
           models_rsv_15_300$model_weighted_adjusted,
           omit.coefs = var_to_omit,
           robust = TRUE,
           # models$model_weighted_adjusted_time,
           model.names = c("Unweighted, unadjusted",
                           "Unweighted, adjusted",
                           "Weighted (LR), unadjusted",
                           "Weighted (LR), adjusted"),
                           # "Weighted, adjusted for CE week"),
           exp = TRUE)
ggsave("figures/Figure_4a_rsv_15_300.png", "width" = 20, "height" =10, "units" = "cm")

```

# Figure 4b: RSV within 15-180 days (past post-acute)

```{r rsv_15_180, echo = FALSE, output = FALSE, message = FALSE , warning = FALSE}

outcome_15_180 = "outcome_rsv_15_to_180"
comparison_group = "Influenza"

iptw_flu_15_180 <- analytic_dataset_final %>%
  mutate(exclude = case_when( is.na(days_from_index_to_rsv) ~ 0,
                              days_from_index_to_rsv >= 15 ~ 0,
                              TRUE ~ 1)) %>%
  filter(exclude==0) %>%
  do_iptw(cohort_entry_start_date = cohort_entry_start_date,
          comparison_cohort = comparison_group,
          weight_formula = "covid~age_group+sex_cat+race_eth_cat+ce_week_factor",
          iptw_description = paste0("covid_", comparison_group, "_", outcome_15_180))

rsv_iptw_15_180 <- results_tbl( paste0(paste0("covid_", comparison_group, "_", outcome_15_180),'_tabc')) %>% collect()
models_rsv_15_180 = list()
rsv_iptw_15_180 <- rsv_iptw_15_180 %>% mutate(hospitalized_at_index = if_else(hospitalized_at_index == "Hospitalized", "Yes", "No"), 
                              across(c("util_inpatient", "util_outpatient", "util_other", "util_ed"), 
                                     ~recode(.x, "no_visits" = "None", "low_utilizer" = "Low","moderate_utilizer" = "Moderate", "high_utilizer" = "High")),
                              pulmonary_respiratory = recode(pulmonary_respiratory, "0" = "No", "1" = "Yes")) %>%
  rename(`Age groups: ` = age_group,
         `Hospitalized for index infection: ` = hospitalized_at_index,
         # `Prior inpatient visit frequency: ` = util_inpatient,
         # `Prior outpatient visit frequency: ` = util_outpatient,
         # `Prior ER visit frequency: ` = util_ed,
         # `Prior other visit frequency: ` = util_other,
         `Pulmonary Respiratory: ` = pulmonary_respiratory,
         `Race: ` = race_eth_cat,
         `Gender: ` = sex_cat,
         `SARS-CoV-2 Infection: ` = covid)

models_rsv_15_180$model_unweighted_unadjusted <- run_logistic_regression(df = rsv_iptw_15_180,
                                                       model_formula = paste0(outcome_15_180, " ~ `SARS-CoV-2 Infection: `"),
                                                       weight_method = "none")

models_rsv_15_180$model_unweighted_adjusted <- run_logistic_regression(df = rsv_iptw_15_180,
                                                         model_formula = paste0(outcome_15_180,
                                                                                formula_no_pulmonary, " + `Pulmonary Respiratory: `"), 
                                                         weight_method = "none")

models_rsv_15_180$model_weighted_unadjusted <- run_logistic_regression(df = rsv_iptw_15_180,
                                                       model_formula = paste0(outcome_15_180, " ~ `SARS-CoV-2 Infection: `"),
                                                       weight_method = "lr")

models_rsv_15_180$model_weighted_adjusted <- run_logistic_regression(df = rsv_iptw_15_180,
                                                         model_formula = paste0(outcome_15_180,
                                                                                formula_no_pulmonary), #" + `Pulmonary Respiratory: `"), 
                                                         weight_method = "lr")

models_rsv_15_180$model_weighted_adjusted_time <- run_logistic_regression(df = rsv_iptw_15_180,
                                                         model_formula = paste0(outcome_15_180,
                                                                                formula_no_pulmonary, " + `Pulmonary Respiratory: ` + ce_week_factor"),
                                                         weight_method = "lr")

```

```{r figure_4b, echo = FALSE, warning = FALSE, message = FALSE, fig.width=12, fig.height=6}

plot_summs(models_rsv_15_180$model_unweighted_unadjusted,
           models_rsv_15_180$model_unweighted_adjusted,
           models_rsv_15_180$model_weighted_unadjusted,
           models_rsv_15_180$model_weighted_adjusted,
           omit.coefs = var_to_omit,  
           robust = TRUE,  
           # models$model_weighted_adjusted_time,
           model.names = c("Unweighted, unadjusted",
                           "Unweighted, adjusted",
                           "Weighted (LR), unadjusted",
                           "Weighted (LR), adjusted"),
                           # "Weighted, adjusted for CE week"),
           exp = TRUE)
ggsave("figures/Figure_4b_rsv_15_180.png", "width" = 20, "height" =10, "units" = "cm")

export_summs(models_rsv_15_180$model_unweighted_unadjusted,
           models_rsv_15_180$model_unweighted_adjusted,
           models_rsv_15_180$model_weighted_unadjusted,
           models_rsv_15_180$model_weighted_adjusted,
           # models$model_weighted_adjusted_time,
           model.names = c("Unweighted, unadjusted",
                           "Unweighted, adjusted",
                           "Weighted (LR), unadjusted",
                           "Weighted (LR), adjusted"),
                           # "Weighted, adjusted for CE week"),
           exp = TRUE)
```

```{r }
```

## Figure 5a: Sensitivity analysis: Subsequent Respiratory infection within 30-180 days, EXCLUDING COVID
```{r sub_resp_with_covid_30_180, echo = FALSE, output = FALSE, message = FALSE , warning = FALSE}
# fig.width=12, fig.height
# TODO really need to figure out what the deal with utilization is
outcome_ari = "outcome_resp30d"
comparison_group_string_ari = "Influenza"
comparison_group_ari = comparison_group_string_ari

# iptw_flu_2b_no_covid <- analytic_dataset_final_resp %>%
#   filter(resp_outcome_is_reinfection=="0") %>% # TODO allow for re-infection
#   do_iptw(cohort_entry_start_date = cohort_entry_start_date,
#           comparison_cohort = comparison_group,
#           weight_formula = "covid~age_group+sex_cat+race_eth_cat+ce_week_factor+pulmonary_respiratory",
#           iptw_description = paste0("resp_study_covid_", comparison_group, "_", outcome_ari))

dataset_with_iptw_ari <- results_tbl( paste0(paste0("resp_study_covid_", comparison_group_ari, "_", outcome_ari),'_tabc')) %>%
  collect()
dataset_with_iptw_ari <- dataset_with_iptw_ari %>% mutate(across(c("util_inpatient", "util_outpatient", "util_other", "util_ed"), 
                                     ~recode(.x, "no_visits" = "None", "low_utilizer" = "Low","moderate_utilizer" = "Moderate", "high_utilizer" = "High")),
                              pulmonary_respiratory = recode(pulmonary_respiratory, "0" = "No", "1" = "Yes")) %>%
  rename(`Age groups: ` = age_group,
         `Hospitalized for index infection: ` = hospitalized_at_index,
         # `Prior inpatient visit frequency: ` = util_inpatient,
         # `Prior outpatient visit frequency: ` = util_outpatient,
         # `Prior ER visit frequency: ` = util_ed,
         # `Prior other visit frequency: ` = util_other,
         `Pulmonary Respiratory: ` = pulmonary_respiratory,
         `Race: ` = race_eth_cat,
         `Gender: ` = sex_cat,
         `SARS-CoV-2 Infection: ` = covid)

models_ari = list()

models_ari$model_unweighted_unadjusted <- run_logistic_regression(df = dataset_with_iptw_ari,
                                                       model_formula = paste0(outcome_ari, " ~ `SARS-CoV-2 Infection: `"),
                                                       weight_method = "none")

models_ari$model_unweighted_adjusted <- run_logistic_regression(df = dataset_with_iptw_ari,
                                                         model_formula = paste0(outcome_ari,
                                                                                formula_no_pulmonary, " + `Pulmonary Respiratory: `"), 
                                                         weight_method = "none")

models_ari$model_weighted_unadjusted <- run_logistic_regression(df = dataset_with_iptw_ari,
                                                       model_formula = paste0(outcome_ari, " ~ `SARS-CoV-2 Infection: `"),
                                                       weight_method = "lr")

# TODO something is wrong with inpatient
models_ari$model_weighted_adjusted <- run_logistic_regression(df = dataset_with_iptw_ari,
                                                         model_formula = paste0(outcome_ari,
                                                                                formula_no_pulmonary, " + `Pulmonary Respiratory: `"), 
                                                         weight_method = "lr")

# models_ari$model_weighted_adjusted_time <- run_logistic_regression(df = dataset_with_iptw_ari,
#                                                          model_formula = paste0(outcome_ari,
#                                                                                 " ~ `SARS-CoV-2 Infection: ` + `Age groups: ` + `Race: ` + `Gender: ` + `Hospitalized for index infection: ` + `Prior inpatient visit frequency: `+ `Prior outpatient visit frequency: ` + `Prior ER visit frequency: ` + `Prior other visit frequency: ` + `Pulmonary Respiratory: ` + ce_week_factor"),
                                                         # weight_method = "lr")

```

```{r figure_5a_exclude_covid, echo = FALSE, warning = FALSE, message = FALSE, fig.width=12, fig.height=6}

plot_summs(models_ari$model_unweighted_unadjusted,
           models_ari$model_unweighted_adjusted,
           models_ari$model_weighted_unadjusted,
           models_ari$model_weighted_adjusted,
           # models$model_weighted_adjusted_time,
           omit.coefs = var_to_omit,  
           model.names = c("Unweighted, unadjusted",
                           "Unweighted, adjusted",
                           "Weighted (LR), unadjusted",
                           "Weighted (LR), adjusted"),
                           # "Weighted, adjusted for CE week"),
           exp = TRUE)
ggsave("figures/Figure_5a_ari_exclude_covid_30_180.png", "width" = 20, "height" =10, "units" = "cm")

  export_summs(models_ari$model_unweighted_unadjusted,
             models_ari$model_unweighted_adjusted,
             models_ari$model_weighted_unadjusted,
             models_ari$model_weighted_adjusted,
             # models$model_weighted_adjusted_time,
             model.names = c("Unweighted, unadjusted",
                             "Unweighted, adjusted",
                             "Weighted (LR), unadjusted",
                             "Weighted (LR), adjusted"),
                           # "Weighted, adjusted for CE week"),
           exp = TRUE)

```

## Figure 5b: Sensitivity analysis: Subsequent Respiratory infection within 15-180 days, EXCLUDING COVID
```{r sub_resp_with_covid_15_180, echo = FALSE, output = FALSE, message = FALSE , warning = FALSE}
# fig.width=12, fig.height
# TODO really need to figure out what the deal with utilization is
outcome_ari_15 = "outcome_resp15d"
comparison_group_string_ari = "Influenza"
comparison_group_ari = comparison_group_string_ari

# iptw_flu_5b_no_covid <- analytic_dataset_final_resp %>%
#   filter(resp_outcome_is_reinfection=="0") %>% # TODO allow for re-infection
#   do_iptw(cohort_entry_start_date = cohort_entry_start_date,
#           comparison_cohort = comparison_group,
#           weight_formula = "covid~age_group+sex_cat+race_eth_cat+ce_week_factor+pulmonary_respiratory",
#           iptw_description = paste0("resp_covid_", comparison_group, "_", outcome_ari_15))

dataset_with_iptw_ari_15 <- results_tbl( paste0(paste0("resp_covid_", comparison_group_ari, "_", outcome_ari_15),'_tabc')) %>%
  collect()
dataset_with_iptw_ari_15 <- dataset_with_iptw_ari_15 %>% mutate(across(c("util_inpatient", "util_outpatient", "util_other", "util_ed"), 
                                     ~recode(.x, "no_visits" = "None", "low_utilizer" = "Low","moderate_utilizer" = "Moderate", "high_utilizer" = "High")),
                              pulmonary_respiratory = recode(pulmonary_respiratory, "0" = "No", "1" = "Yes")) %>%
  rename(`Age groups: ` = age_group,
         `Hospitalized for index infection: ` = hospitalized_at_index,
         # `Prior inpatient visit frequency: ` = util_inpatient,
         # `Prior outpatient visit frequency: ` = util_outpatient,
         # `Prior ER visit frequency: ` = util_ed,
         # `Prior other visit frequency: ` = util_other,
         `Pulmonary Respiratory: ` = pulmonary_respiratory,
         `Race: ` = race_eth_cat,
         `Gender: ` = sex_cat,
         `SARS-CoV-2 Infection: ` = covid)

models_ari_15 = list()

models_ari_15$model_unweighted_unadjusted <- run_logistic_regression(df = dataset_with_iptw_ari_15,
                                                       model_formula = paste0(outcome_ari_15, " ~ `SARS-CoV-2 Infection: `"),
                                                       weight_method = "none")

models_ari_15$model_unweighted_adjusted <- run_logistic_regression(df = dataset_with_iptw_ari_15,
                                                         model_formula = paste0(outcome_ari_15,
                                                                                formula_no_pulmonary, " + `Pulmonary Respiratory: `"), 
                                                         weight_method = "none")

models_ari_15$model_weighted_unadjusted <- run_logistic_regression(df = dataset_with_iptw_ari_15,
                                                       model_formula = paste0(outcome_ari_15, " ~ `SARS-CoV-2 Infection: `"),
                                                       weight_method = "lr")

# TODO something is wrong with inpatient
models_ari_15$model_weighted_adjusted <- run_logistic_regression(df = dataset_with_iptw_ari_15,
                                                         model_formula = paste0(outcome_ari_15,
                                                                                formula_no_pulmonary, " + `Pulmonary Respiratory: `"), 
                                                         weight_method = "lr")

# models_ari$model_weighted_adjusted_time <- run_logistic_regression(df = dataset_with_iptw_ari,
#                                                          model_formula = paste0(outcome_ari,
#                                                                                 " ~ `SARS-CoV-2 Infection: ` + `Age groups: ` + `Race: ` + `Gender: ` + `Hospitalized for index infection: ` + `Prior inpatient visit frequency: `+ `Prior outpatient visit frequency: ` + `Prior ER visit frequency: ` + `Prior other visit frequency: ` + `Pulmonary Respiratory: ` + ce_week_factor"),
                                                         # weight_method = "lr")

```

```{r figure_5b_exclude_covid, echo = FALSE, warning = FALSE, message = FALSE, fig.width=12, fig.height=6}

plot_summs(models_ari_15$model_unweighted_unadjusted,
           models_ari_15$model_unweighted_adjusted,
           models_ari_15$model_weighted_unadjusted,
           models_ari_15$model_weighted_adjusted,
           # models$model_weighted_adjusted_time,
           omit.coefs = var_to_omit,  
           model.names = c("Unweighted, unadjusted",
                           "Unweighted, adjusted",
                           "Weighted (LR), unadjusted",
                           "Weighted (LR), adjusted"),
                           # "Weighted, adjusted for CE week"),
           exp = TRUE)
ggsave("figures/Figure_5b_ari_exclude_covid_15_180.png", "width" = 20, "height" =10, "units" = "cm")
```

## Figure 5c: Sensitivity analysis: Subsequent General (any) infection within 30-180 days (**excluding covid**)
```{r general_infection_no_covid_30_180, echo = FALSE, output = FALSE, message = FALSE , warning = FALSE}

# TODO really need to figure out what the deal with utilization is
outcome = "outcome_general30d"
comparison_group_string_resp = "Influenza"
comparison_group = comparison_group_string_resp

# iptw_flu_2c_exclude_covid <- analytic_dataset_final_resp %>%
#   filter(resp_outcome_is_reinfection=="0") %>% # TODO allow for re-infection
#   do_iptw(cohort_entry_start_date = cohort_entry_start_date_resp,
#           comparison_cohort = comparison_group_ari,
#           weight_formula = "covid~age_group+sex_cat+race_eth_cat+ce_week_factor+pulmonary_respiratory",
#           iptw_description = paste0("resp_stdy_covid_", comparison_group, "_", outcome))

dataset_with_iptw <- results_tbl( paste0(paste0("resp_stdy_covid_", comparison_group, "_", outcome),'_tabc')) %>%
  collect()
dataset_with_iptw <- dataset_with_iptw %>%  mutate(across(c("util_inpatient", "util_outpatient", "util_other", "util_ed"), 
                                     ~recode(.x, "no_visits" = "None", "low_utilizer" = "Low","moderate_utilizer" = "Moderate", "high_utilizer" = "High")),
                              pulmonary_respiratory = recode(pulmonary_respiratory, "0" = "No", "1" = "Yes")) %>%
  rename(`Age groups: ` = age_group,
         `Hospitalized for index infection: ` = hospitalized_at_index,
         # `Prior inpatient visit frequency: ` = util_inpatient,
         # `Prior outpatient visit frequency: ` = util_outpatient,
         # `Prior ER visit frequency: ` = util_ed,
         # `Prior other visit frequency: ` = util_other,
         `Pulmonary Respiratory: ` = pulmonary_respiratory,
         `Race: ` = race_eth_cat,
         `Gender: ` = sex_cat,
         `SARS-CoV-2 Infection: ` = covid)

models = list()

models$model_unweighted_unadjusted <- run_logistic_regression(df = dataset_with_iptw,
                                                       model_formula = paste0(outcome, "~ `SARS-CoV-2 Infection: `"),
                                                       weight_method = "none")

models$model_unweighted_adjusted <- run_logistic_regression(df = dataset_with_iptw,
                                                         model_formula = paste0(outcome,
                                                                               formula_no_pulmonary, " + `Pulmonary Respiratory: `"), 
                                                         weight_method = "none")

models$model_weighted_unadjusted <- run_logistic_regression(df = dataset_with_iptw,
                                                       model_formula = paste0(outcome, 
                                                                              " ~ `SARS-CoV-2 Infection: `"),
                                                       weight_method = "lr")

# TODO something is wrong with inpatient
models$model_weighted_adjusted <- run_logistic_regression(df = dataset_with_iptw,
                                                         model_formula = paste0(outcome,
                                                                                formula_no_pulmonary, " + `Pulmonary Respiratory: `"), 
                                                         weight_method = "lr")

# models$model_weighted_adjusted_time <- run_logistic_regression(df = dataset_with_iptw,
#                                                          model_formula = paste0(outcome,
#                                                                                 "~ `SARS-CoV-2 Infection: ` + `Age groups: ` + `Race: ` + `Gender: ` + `Hospitalized for index infection: ` + `Prior inpatient visit frequency: `+ `Prior outpatient visit frequency: ` + `Prior ER visit frequency: ` + `Prior other visit frequency: ` + `Pulmonary Respiratory: ` + ce_week_factor"),
#                                                          weight_method = "lr")

```

```{r figure_5b_no_covid, echo = FALSE, warning = FALSE, message = FALSE, fig.width=12, fig.height=6}

plot_summs(models$model_unweighted_unadjusted,
           models$model_unweighted_adjusted,
           models$model_weighted_unadjusted,
           models$model_weighted_adjusted,
           omit.coefs = var_to_omit,  
           # models$model_weighted_adjusted_time,
           model.names = c("Unweighted, unadjusted",
                           "Unweighted, adjusted",
                           "Weighted (LR), unadjusted",
                           "Weighted (LR), adjusted"),
                           # "Weighted, adjusted for CE week"),
           exp = TRUE)
ggsave("figures/Figure_5b_general_exclude_covid_30_180.png", "width" = 20, "height" =10, "units" = "cm")

export_summs(models$model_unweighted_unadjusted,
           models$model_unweighted_adjusted,
           models$model_weighted_unadjusted,
           models$model_weighted_adjusted,
           # models$model_weighted_adjusted_time,
           model.names = c("Unweighted, unadjusted",
                           "Unweighted, adjusted",
                           "Weighted (LR), unadjusted",
                           "Weighted (LR), adjusted"),
                           # "Weighted, adjusted for CE week"),
           exp = TRUE)
```

## Figure 5d: Sensitivity analysis: Subsequent General (any) infection within 15-180 days (**including covid**)
```{r general_infection_with_covid_15_180, echo = FALSE, output = FALSE, message = FALSE , warning = FALSE}

# TODO really need to figure out what the deal with utilization is
# Of I know why

outcome_general_15_180 = "outcome_general15d"
comparison_group = "Influenza"

# any_inf_iptw_flu_outcome_general_15_180 <- analytic_dataset_final_resp %>%
#   filter(resp_outcome_is_reinfection=="0") %>% # TODO allow for re-infection
#   do_iptw(cohort_entry_start_date = cohort_entry_start_date_resp,
#           comparison_cohort = comparison_group,
#           weight_formula = "covid~age_group+sex_cat+race_eth_cat+ce_week_factor+pulmonary_respiratory",
#           iptw_description = paste0("resp_study_covid_", comparison_group, "_", outcome_general_15_180))

dataset_with_iptw_general_15_180 <- results_tbl( paste0(paste0("resp_covid_", comparison_group, "_", outcome_general_15_180),'_tabc')) %>%
  collect()
dataset_with_iptw_general_15_180 <- dataset_with_iptw_general_15_180 %>%  mutate(across(c("util_inpatient", "util_outpatient", "util_other", "util_ed"), 
                                     ~recode(.x, "no_visits" = "None", "low_utilizer" = "Low","moderate_utilizer" = "Moderate", "high_utilizer" = "High")),
                              pulmonary_respiratory = recode(pulmonary_respiratory, "0" = "No", "1" = "Yes")) %>%
  rename(`Age groups: ` = age_group,
         `Hospitalized for index infection: ` = hospitalized_at_index,
         # `Prior inpatient visit frequency: ` = util_inpatient,
         # `Prior outpatient visit frequency: ` = util_outpatient,
         # `Prior ER visit frequency: ` = util_ed,
         # `Prior other visit frequency: ` = util_other,
         `Pulmonary Respiratory: ` = pulmonary_respiratory,
         `Race: ` = race_eth_cat,
         `Gender: ` = sex_cat,
         `SARS-CoV-2 Infection: ` = covid)


models_general_15_180 = list()

models_general_15_180$model_unweighted_unadjusted <- run_logistic_regression(df = dataset_with_iptw_general_15_180,
                                                       model_formula = paste0(outcome_general_15_180, " ~ `SARS-CoV-2 Infection: `"),
                                                       weight_method = "none")

models_general_15_180$model_unweighted_adjusted <- run_logistic_regression(df = dataset_with_iptw_general_15_180,
                                                         model_formula = paste0(outcome_general_15_180,
                                                                                formula_no_pulmonary, " + `Pulmonary Respiratory: `"), 
                                                         weight_method = "none")

models_general_15_180$model_weighted_unadjusted <- run_logistic_regression(df = dataset_with_iptw_general_15_180,
                                                       model_formula = paste0(outcome_general_15_180, " ~ `SARS-CoV-2 Infection: `"),
                                                       weight_method = "lr")

# TODO something is wrong with inpatient
models_general_15_180$model_weighted_adjusted <- run_logistic_regression(df = dataset_with_iptw_general_15_180,
                                                         model_formula = paste0(outcome_general_15_180,
                                                                               formula_no_pulmonary, " + `Pulmonary Respiratory: `"), 
                                                         weight_method = "lr")

# models$model_weighted_adjusted_time <- run_logistic_regression(df = dataset_with_iptw,
#                                                          model_formula = paste0(outcome,
#                                                                                 " ~ `SARS-CoV-2 Infection: ` + `Age groups: ` + `Race: ` + `Gender: ` + `Hospitalized for index infection: ` + `Prior inpatient visit frequency: `+ `Prior outpatient visit frequency: ` + `Prior ER visit frequency: ` + `Prior other visit frequency: ` + `Pulmonary Respiratory: ` + ce_week_factor"),
#                                                          weight_method = "lr")

```

```{r figure_5c, echo = FALSE, warning = FALSE, message = FALSE, fig.width=12, fig.height=6}

plot_summs(models_general_15_180$model_unweighted_unadjusted,
           models_general_15_180$model_unweighted_adjusted,
           models_general_15_180$model_weighted_unadjusted,
           models_general_15_180$model_weighted_adjusted,
           omit.coefs = var_to_omit,  
           # models$model_weighted_adjusted_time,
           model.names = c("Unweighted, unadjusted",
                           "Unweighted, adjusted",
                           "Weighted (LR), unadjusted",
                           "Weighted (LR), adjusted"),
                           # "Weighted, adjusted for CE week"),
           exp = TRUE)
ggsave("figures/Figure_5c_general_exclude_covid_15_180.png", "width" = 20, "height" =10, "units" = "cm")

export_summs(models_highrisk_2a$model_unweighted_unadjusted,
           models_highrisk_2a$model_unweighted_adjusted,
           models_highrisk_2a$model_weighted_unadjusted,
           models_highrisk_2a$model_weighted_adjusted,
           # models$model_weighted_adjusted_time,
           model.names = c("Unweighted, unadjusted",
                           "Unweighted, adjusted",
                           "Weighted (LR), unadjusted",
                           "Weighted (LR), adjusted"),
                           # "Weighted, adjusted for CE week"),
           exp = TRUE)



```

# Figure 6. Co-infection results  
```{r figure_6_coinfection, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=8, fig.height=6}
analytic_dataset_final %>% 
  group_by(sub_cohort, outcome_rsv_same_day, outcome_rsv_1_to_60, outcome_rsv_61_to_180) %>% 
  summarise(n = n_distinct(person_id)) %>% 
  ungroup() %>% 
  group_by(sub_cohort) %>% 
  mutate(total = sum(n)) %>% 
  mutate(p = n/total) %>% 
  mutate(pct = paste0(as.character(round(p*100, 2)), " %")) %>% 
  ungroup() %>%
  filter(outcome_rsv_same_day !=0 | outcome_rsv_1_to_60 !=0 | outcome_rsv_61_to_180 != 0)%>%
  prettify_kable()

```

# Figure 7: Sensitivity analysis RSV outcome, high risk conditions
```{r figure_7_highrisk_rsv, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=8, fig.height=6}
models_highrisk = list()

outcome_0_60 = "outcome_rsv_0_to_60"
comparison_group = comparison_group_string

formula_no_pulmonary = "~ `SARS-CoV-2 Infection: ` + `Age groups: ` + `Race: ` + `Gender: ` + `Hospitalized for index infection: ` +  util_inpatient +  util_outpatient +  util_ed + util_other"
# iptw_0_60_highrisk <- analytic_dataset_final_highrisk %>%
#   do_iptw(cohort_entry_start_date = cohort_entry_start_date,
#           comparison_cohort = comparison_group,
#           weight_formula = "covid~age_group+sex_cat+race_eth_cat+ce_week_factor+highrisk_flag",
#           iptw_description = "covid_Influenza_outcome_rsv_0_to_60_highrisk")
df_0_60_highrisk <- results_tbl( paste0("covid_Influenza_outcome_rsv_0_to_60_highrisk",'_tabc')) %>% 
  collect()

df_0_60_highrisk <- df_0_60_highrisk %>% mutate(hospitalized_at_index = if_else(hospitalized_at_index == "Hospitalized", "Yes", "No"), 
                              across(c("util_inpatient", "util_outpatient", "util_other", "util_ed"), 
                                     ~recode(.x, "no_visits" = "None", "low_utilizer" = "Low","moderate_utilizer" = "Moderate", "high_utilizer" = "High")),
                              pulmonary_respiratory = recode(pulmonary_respiratory, "0" = "No", "1" = "Yes")) %>%
  rename(`Age groups: ` = age_group,
         `Hospitalized for index infection: ` = hospitalized_at_index,
         # `Prior inpatient visit frequency: ` = util_inpatient,
         # `Prior outpatient visit frequency: ` = util_outpatient,
         # `Prior ER visit frequency: ` = util_ed,
         # `Prior other visit frequency: ` = util_other,
         `Pulmonary Respiratory: ` = pulmonary_respiratory,
         `Race: ` = race_eth_cat,
         `Gender: ` = sex_cat,
         `SARS-CoV-2 Infection: ` = covid)
models_highrisk$unw_unadj_0_to_60 <- run_logistic_regression(df = df_0_60_highrisk,
                                                    model_formula = paste0(outcome_0_60, " ~ `SARS-CoV-2 Infection: `"),
                                                    weight_method = "none")

models_highrisk$w_adj_0_to_60 <- run_logistic_regression(df = df_0_60_highrisk,
                                                model_formula = paste0(outcome_0_60,
                                                                       formula_no_pulmonary, " + highrisk_flag"), 
                                                weight_method = "lr")
outcome_1_60 = "outcome_rsv_1_to_60"
# iptw_1_60_highrisk <- analytic_dataset_final_highrisk %>%
#    do_iptw(cohort_entry_start_date = cohort_entry_start_date,
#            comparison_cohort = comparison_group,
#            weight_formula = "covid~age_group+sex_cat+race_eth_cat+ce_week_factor+highrisk_flag",
#            iptw_description = "covid_Influenza_outcome_rsv_1_to_60_highrisk")

df_1_60_highrisk <- results_tbl( paste0("covid_Influenza_outcome_rsv_1_to_60_highrisk",'_tabc')) %>% 
  collect()

df_1_60_highrisk <- df_1_60_highrisk %>%  mutate(hospitalized_at_index = if_else(hospitalized_at_index == "Hospitalized", "Yes", "No"), 
                              across(c("util_inpatient", "util_outpatient", "util_other", "util_ed"), 
                                     ~recode(.x, "no_visits" = "None", "low_utilizer" = "Low","moderate_utilizer" = "Moderate", "high_utilizer" = "High")),
                              pulmonary_respiratory = recode(pulmonary_respiratory, "0" = "No", "1" = "Yes")) %>%
  rename(`Age groups: ` = age_group,
         `Hospitalized for index infection: ` = hospitalized_at_index,
         # `Prior inpatient visit frequency: ` = util_inpatient,
         # `Prior outpatient visit frequency: ` = util_outpatient,
         # `Prior ER visit frequency: ` = util_ed,
         # `Prior other visit frequency: ` = util_other,
         `Pulmonary Respiratory: ` = pulmonary_respiratory,
         `Race: ` = race_eth_cat,
         `Gender: ` = sex_cat,
         `SARS-CoV-2 Infection: ` = covid)

models_highrisk$unw_unadj_1_to_60 <- run_logistic_regression(df = df_1_60_highrisk,
                                                    model_formula = paste0(outcome_1_60, " ~ `SARS-CoV-2 Infection: `"),
                                                    weight_method = "none")

models_highrisk$w_adj_1_to_60 <- run_logistic_regression(df = df_1_60_highrisk,
                                                model_formula = paste0(outcome_1_60,
                                                                       formula_no_pulmonary, " + highrisk_flag"), 
                                                weight_method = "lr")


outcome_30_180 = "outcome_rsv_30_to_180"

# rsv_iptw_30_180_highrisk <- analytic_dataset_final_highrisk %>%
#   do_iptw(cohort_entry_start_date = cohort_entry_start_date,
#           comparison_cohort = comparison_group,
#           weight_formula = "covid~age_group+sex_cat+race_eth_cat+ce_week_factor+highrisk_flag",
#           iptw_description = "covid_Influenza_rsv_30_to_180_highrisk")

df_30_180_highrisk <- results_tbl( paste0("covid_Influenza_rsv_30_to_180_highrisk",'_tabc')) %>%
  collect()

df_30_180_highrisk <- df_30_180_highrisk %>%  mutate(hospitalized_at_index = if_else(hospitalized_at_index == "Hospitalized", "Yes", "No"), 
                              across(c("util_inpatient", "util_outpatient", "util_other", "util_ed"), 
                                     ~recode(.x, "no_visits" = "None", "low_utilizer" = "Low","moderate_utilizer" = "Moderate", "high_utilizer" = "High")),
                              pulmonary_respiratory = recode(pulmonary_respiratory, "0" = "No", "1" = "Yes")) %>%
  rename(`Age groups: ` = age_group,
         `Hospitalized for index infection: ` = hospitalized_at_index,
         # `Prior inpatient visit frequency: ` = util_inpatient,
         # `Prior outpatient visit frequency: ` = util_outpatient,
         # `Prior ER visit frequency: ` = util_ed,
         # `Prior other visit frequency: ` = util_other,
         `Pulmonary Respiratory: ` = pulmonary_respiratory,
         `Race: ` = race_eth_cat,
         `Gender: ` = sex_cat,
         `SARS-CoV-2 Infection: ` = covid)


models_highrisk$unw_unadj_30_to_180 <- run_logistic_regression(df = df_30_180_highrisk,
                                                      model_formula = paste0(outcome_30_180, " ~ `SARS-CoV-2 Infection: `"),
                                                      weight_method = "none")

models_highrisk$w_adj_30_to_180 <- run_logistic_regression(df = df_30_180_highrisk,
                                                  model_formula = paste0(outcome_30_180,
                                                                          formula_no_pulmonary, "+ highrisk_flag"), 
                                                  weight_method = "lr")

var_to_omit <- c("(Intercept)", "util_inpatientNone", "util_inpatientLow", "util_inpatientHigh", "util_inpatientModerate",
                 "util_outpatientNone", "util_outpatientLow", "util_outpatientHigh", "util_outpatientModerate",
                 "util_edNone", "util_edLow", "util_edHigh", "util_edModerate",
                 "util_otherNone", "util_otherLow", "util_otherHigh", "util_otherModerate")

plot_summs(models_highrisk$unw_unadj_0_to_60,
           models_highrisk$w_adj_0_to_60,
           models_highrisk$unw_unadj_1_to_60,
           models_highrisk$w_adj_1_to_60,
           models_highrisk$unw_unadj_30_to_180,
           models_highrisk$w_adj_30_to_180,
           omit.coefs = var_to_omit, 
           model.names = c("RSV 0-60d: Unweighted, unadjusted",
                           "RSV 0-60d: Weighted, adjusted",
                           "RSV 1-60d: Unweighted, unadjusted",
                           "RSV 1-60d: Weighted, adjusted",
                           "RSV 15-180d: Unweighted, unadjusted",
                           "RSV 15-180d: Weighted, adjusted"),
           # "Weighted, adjusted for CE week"),
           exp = TRUE)
ggsave("figures/Figure_7a_rsv_highrisk_3periods.png", "width" = 20, "height" =10, "units" = "cm")

export_summs(models_highrisk$unw_unadj_0_to_60,
             models_highrisk$w_adj_0_to_60,
             models_highrisk$unw_unadj_1_to_60,
             models_highrisk$w_adj_1_to_60,
             models_highrisk$unw_unadj_30_to_180,
             models_highrisk$w_adj_30_to_180,
             omit.coefs = var_to_omit,  
             model.names = c("RSV 0-60d: Unweighted, unadjusted",
                             "RSV 0-60d: Weighted, adjusted",
                             "RSV 1-60d: Unweighted, unadjusted",
                             "RSV 1-60d: Weighted, adjusted",
                             "RSV 15-180d: Unweighted, unadjusted",
                             "RSV 15-180d: Weighted, adjusted"),
             # "Weighted, adjusted for CE week"),
             exp = TRUE)
```
